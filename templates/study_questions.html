{% extends "base.html" %}
{% block content %}

<h2 class="text-2xl font-semibold mb-6 text-gray-800">í•™ìŠµ ë¬¸ì œ (ë¹ˆì¹¸ ì±„ìš°ê¸°)</h2>

<!-- ì¹´í…Œê³ ë¦¬ ì„ íƒ -->
<div class="mb-6">
  <label class="block mb-2 text-gray-700 font-medium">ì¹´í…Œê³ ë¦¬ ì„ íƒ</label>
  <select id="categorySelector" class="border rounded px-3 py-2 w-full max-w-md">
    <option value="">ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
    {% for category in categories %}
      <option value="{{ category }}">{{ category }}</option>
    {% endfor %}
  </select>
</div>

<!-- ì‹œì‘ ë²„íŠ¼ -->
<div class="mb-6 flex gap-3">
  <button onclick="startStudy()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition font-semibold">
    í•™ìŠµ ì‹œì‘
  </button>
  <button onclick="openQuestionManager()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition font-semibold">
    ë¬¸ì œ ê´€ë¦¬
  </button>
</div>

<!-- í•™ìŠµ ëª¨ë‹¬ -->
<div id="studyModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
  <div class="bg-white rounded-2xl shadow-2xl w-[900px] max-h-[90vh] overflow-y-auto p-8 relative">
    <!-- í—¤ë” -->
    <div class="flex justify-between items-center mb-6 border-b pb-4">
      <div>
        <h2 class="text-2xl font-bold text-gray-800">ë¹ˆì¹¸ ì±„ìš°ê¸° í•™ìŠµ</h2>
        <p class="text-sm text-gray-500 mt-1">ë¬¸ì œ: <span id="currentQuestionNum">1</span> / <span id="totalQuestions">0</span></p>
      </div>
      <button onclick="closeStudyModal()" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
    </div>

    <!-- ì§„í–‰ë¥  ë°” -->
    <div class="mb-6">
      <div class="w-full bg-gray-200 rounded-full h-2">
        <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
      </div>
    </div>

    <!-- ë¬¸ì œ ì˜ì—­ -->
    <div id="questionContainer" class="mb-6">
      <div class="bg-blue-50 border-l-4 border-blue-600 p-6 mb-6 rounded">
        <p class="text-sm text-blue-800 font-semibold mb-2">ë¬¸ì œ <span id="questionNumber"></span></p>
        <p id="questionText" class="text-lg text-gray-800 font-medium leading-relaxed whitespace-pre-line"></p>
      </div>

      <!-- ì •ë‹µ í‘œì‹œ -->
      <div class="mb-4 bg-green-50 border-l-4 border-green-500 p-4 rounded">
        <p class="text-sm text-green-800 font-semibold mb-1">âœ“ ì •ë‹µ</p>
        <p id="answerText" class="text-2xl font-bold text-green-700"></p>
      </div>

      <!-- íŒíŠ¸ (ì˜ë¯¸) -->
      <div class="mb-4 bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded">
        <p class="text-sm text-yellow-800 font-semibold mb-1">ğŸ’¡ ì˜ë¯¸</p>
        <p id="hintText" class="text-gray-700"></p>
      </div>
    </div>

    <!-- ë‹¤ìŒ/ì™„ë£Œ ë²„íŠ¼ -->
    <div class="flex justify-between items-center mt-8 pt-4 border-t">
      <button onclick="prevQuestion()" id="prevBtn" class="bg-gray-500 text-white px-6 py-2 rounded hover:bg-gray-600 transition" disabled>
        ì´ì „
      </button>
      <button onclick="nextQuestion()" id="nextBtn" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition">
        ë‹¤ìŒ
      </button>
      <button onclick="completeStudy()" id="submitBtn" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 transition hidden">
        ì™„ë£Œ
      </button>
    </div>
  </div>
</div>

<!-- ê²°ê³¼ ëª¨ë‹¬ -->
<div id="resultModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
  <div class="bg-white rounded-2xl shadow-2xl w-[700px] p-8 relative">
    <div class="text-center">
      <div class="mb-6">
        <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-10 h-10 text-green-600" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
          </svg>
        </div>
        <h2 class="text-3xl font-bold text-gray-800 mb-2">í•™ìŠµ ì™„ë£Œ!</h2>
        <p class="text-gray-600">ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤</p>
      </div>

      <div class="bg-blue-50 rounded-lg p-6 mb-6">
        <p class="text-lg text-gray-700">ì´ <span class="text-2xl font-bold text-blue-600"><span id="resultTotal">0</span>ê°œ</span>ì˜ ë¬¸ì œë¥¼ í•™ìŠµí–ˆìŠµë‹ˆë‹¤</p>
      </div>

      <div class="flex justify-center space-x-3">
        <button onclick="closeResultModal()" class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition font-semibold">
          í™•ì¸
        </button>
        <button onclick="retryStudy()" class="bg-gray-500 text-white px-8 py-3 rounded-lg hover:bg-gray-600 transition font-semibold">
          ë‹¤ì‹œ í•™ìŠµí•˜ê¸°
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ë¬¸ì œ ê´€ë¦¬ ëª¨ë‹¬ -->
<div id="managerModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
  <div class="bg-white rounded-2xl shadow-2xl w-[1000px] max-h-[90vh] overflow-y-auto p-8 relative">
    <div class="flex justify-between items-center mb-6 border-b pb-4">
      <h2 class="text-2xl font-bold text-gray-800">í•™ìŠµ ë¬¸ì œ ê´€ë¦¬</h2>
      <button onclick="closeQuestionManager()" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
    </div>

    <!-- ì¹´í…Œê³ ë¦¬ í•„í„° & ì¶”ê°€ ë²„íŠ¼ -->
    <div class="flex justify-between items-center mb-4">
      <div class="flex gap-3 items-center">
        <label class="text-sm font-medium text-gray-700">ì¹´í…Œê³ ë¦¬:</label>
        <select id="managerCategorySelector" onchange="loadQuestionList()" class="border rounded px-3 py-2">
          <option value="">ì „ì²´</option>
          {% for category in categories %}
            <option value="{{ category }}">{{ category }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="flex gap-2">
        <button onclick="openBulkPasteModal()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition font-semibold">
          ğŸ“‹ ì—‘ì…€ ë¶™ì—¬ë„£ê¸°
        </button>
        <button onclick="openAddQuestionModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition font-semibold">
          + ë¬¸ì œ ì¶”ê°€
        </button>
      </div>
    </div>

    <!-- ë¬¸ì œ ëª©ë¡ í…Œì´ë¸” -->
    <div class="overflow-x-auto">
      <table class="w-full text-sm border-collapse bg-white shadow-sm rounded-lg">
        <thead>
          <tr class="bg-gradient-to-r from-purple-100 to-indigo-100">
            <th class="border px-3 py-2 text-center font-semibold text-gray-700" style="width: 60px;">ë²ˆí˜¸</th>
            <th class="border px-3 py-2 text-left font-semibold text-gray-700" style="width: 120px;">ì¹´í…Œê³ ë¦¬</th>
            <th class="border px-3 py-2 text-left font-semibold text-gray-700">ë¬¸ì œ</th>
            <th class="border px-3 py-2 text-left font-semibold text-gray-700" style="width: 150px;">ì •ë‹µ</th>
            <th class="border px-3 py-2 text-center font-semibold text-gray-700" style="width: 120px;">ì‘ì—…</th>
          </tr>
        </thead>
        <tbody id="questionListTable">
          <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤ -->
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- ë¬¸ì œ ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
<div id="questionFormModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
  <div class="bg-white rounded-2xl shadow-2xl w-[700px] max-h-[90vh] overflow-y-auto p-8 relative">
    <div class="flex justify-between items-center mb-6 border-b pb-4">
      <h2 id="questionFormTitle" class="text-2xl font-bold text-gray-800">ë¬¸ì œ ì¶”ê°€</h2>
      <button onclick="closeQuestionFormModal()" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
    </div>

    <form id="questionForm" onsubmit="event.preventDefault(); saveQuestion();">
      <input type="hidden" id="questionId">
      
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">ì¹´í…Œê³ ë¦¬</label>
          <input id="formCategory" type="text" class="w-full border rounded px-3 py-2" placeholder="ì˜ˆ: í† ìµ" required>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">ë²ˆí˜¸</label>
          <input id="formNumber" type="number" class="w-full border rounded px-3 py-2" placeholder="1">
        </div>
      </div>

      <div class="mb-4">
        <label class="block text-sm font-semibold text-gray-700 mb-1">ë¬¸ì œ *</label>
        <textarea id="formQuestion" rows="4" class="w-full border rounded px-3 py-2" placeholder="ë¹ˆì¹¸ì´ í¬í•¨ëœ ë¬¸ì œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: A: You should hire someone to help around the house. B: That would certainly make getting chores done _____.)" required></textarea>
      </div>

      <div class="mb-4">
        <label class="block text-sm font-semibold text-gray-700 mb-1">ì •ë‹µ *</label>
        <input id="formCorrectWord" type="text" class="w-full border rounded px-3 py-2" placeholder="ì •ë‹µ ë‹¨ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
      </div>

      <div class="mb-6">
        <label class="block text-sm font-semibold text-gray-700 mb-1">ì˜ë¯¸ (íŒíŠ¸)</label>
        <input id="formMeaning" type="text" class="w-full border rounded px-3 py-2" placeholder="ë‹¨ì–´ì˜ ì˜ë¯¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
      </div>

      <div class="flex justify-end space-x-3">
        <button type="button" onclick="closeQuestionFormModal()" class="px-6 py-2 bg-gray-300 rounded hover:bg-gray-400">ì·¨ì†Œ</button>
        <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">ì €ì¥</button>
      </div>
    </form>
  </div>
</div>

<!-- ì—‘ì…€ ë°ì´í„° ë¶™ì—¬ë„£ê¸° ëª¨ë‹¬ -->
<div id="bulkPasteModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
  <div class="bg-white rounded-2xl shadow-2xl w-[900px] max-h-[90vh] overflow-y-auto p-8 relative">
    <div class="flex justify-between items-center mb-6 border-b pb-4">
      <div>
        <h2 class="text-2xl font-bold text-gray-800">ì—‘ì…€ ë°ì´í„° ë¶™ì—¬ë„£ê¸°</h2>
        <p class="text-sm text-gray-500 mt-1">ì—‘ì…€ì—ì„œ ë³µì‚¬í•œ ë°ì´í„°ë¥¼ ì•„ë˜ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”</p>
      </div>
      <button onclick="closeBulkPasteModal()" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
    </div>

    <!-- ì•ˆë‚´ ë¬¸êµ¬ -->
    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
      <p class="text-sm text-blue-800 font-semibold mb-2">ğŸ“‹ ë°ì´í„° í˜•ì‹ ì•ˆë‚´</p>
      <p class="text-sm text-gray-700">ì—‘ì…€ì—ì„œ ë‹¤ìŒ ìˆœì„œë¡œ ë°ì´í„°ë¥¼ ë³µì‚¬í•˜ì„¸ìš”:</p>
      <p class="text-sm text-gray-700 font-mono mt-1">ì¹´í…Œê³ ë¦¬ &nbsp;&nbsp; ë²ˆí˜¸ &nbsp;&nbsp; ë¬¸ì œ &nbsp;&nbsp; ì •ë‹µ &nbsp;&nbsp; ì˜ë¯¸</p>
      <p class="text-sm text-gray-500 mt-2">â€» íƒ­(Tab)ìœ¼ë¡œ êµ¬ë¶„ëœ ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ìœ¼ë©´ ìë™ìœ¼ë¡œ íŒŒì‹±ë©ë‹ˆë‹¤.</p>
    </div>

    <!-- ë¶™ì—¬ë„£ê¸° ì˜ì—­ -->
    <div class="mb-4">
      <label class="block text-sm font-semibold text-gray-700 mb-2">ì—‘ì…€ ë°ì´í„° ë¶™ì—¬ë„£ê¸°</label>
      <textarea id="bulkPasteArea" rows="10" class="w-full border rounded-lg p-3 font-mono text-sm" 
        placeholder="ì—‘ì…€ì—ì„œ ë³µì‚¬í•œ ë°ì´í„°ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”...&#10;&#10;ì˜ˆì‹œ:&#10;í† ìµ	1	That would certainly make getting chores done _____.	easier	ë” ì‰¬ìš´"></textarea>
    </div>

    <!-- ë¯¸ë¦¬ë³´ê¸° -->
    <div class="mb-4">
      <button onclick="previewBulkData()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
        ë¯¸ë¦¬ë³´ê¸°
      </button>
    </div>

    <div id="bulkPreviewContainer" class="mb-4 hidden">
      <h3 class="text-sm font-semibold text-gray-700 mb-2">ë¯¸ë¦¬ë³´ê¸° (<span id="previewCount">0</span>ê°œ ë¬¸ì œ)</h3>
      <div class="max-h-64 overflow-y-auto border rounded-lg">
        <table class="w-full text-xs">
          <thead class="bg-gray-100 sticky top-0">
            <tr>
              <th class="border px-2 py-1">ì¹´í…Œê³ ë¦¬</th>
              <th class="border px-2 py-1">ë²ˆí˜¸</th>
              <th class="border px-2 py-1">ë¬¸ì œ</th>
              <th class="border px-2 py-1">ì •ë‹µ</th>
              <th class="border px-2 py-1">ì˜ë¯¸</th>
            </tr>
          </thead>
          <tbody id="bulkPreviewTable">
          </tbody>
        </table>
      </div>
    </div>

    <div class="flex justify-end space-x-3">
      <button onclick="closeBulkPasteModal()" class="px-6 py-2 bg-gray-300 rounded hover:bg-gray-400">ì·¨ì†Œ</button>
      <button onclick="submitBulkQuestions()" class="px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700">ì¼ê´„ ì €ì¥</button>
    </div>
  </div>
</div>

<script>
let questions = [];
let currentQuestionIndex = 0;
let selectedCategory = '';
let bulkQuestionsData = [];

// í•™ìŠµ ì‹œì‘
function startStudy() {
  selectedCategory = document.getElementById('categorySelector').value;
  
  if (!selectedCategory) {
    alert('ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
    return;
  }
  
  // ë¬¸ì œ ê°€ì ¸ì˜¤ê¸°
  fetch(`/api/study_questions?category=${encodeURIComponent(selectedCategory)}`)
    .then(res => res.json())
    .then(data => {
      if (data.length === 0) {
        alert('í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì— ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      questions = data;
      currentQuestionIndex = 0;
      
      document.getElementById('totalQuestions').textContent = questions.length;
      
      loadQuestion();
      
      document.getElementById('studyModal').classList.remove('hidden');
      document.getElementById('studyModal').classList.add('flex');
    })
    .catch(err => {
      console.error('ë¬¸ì œ ë¡œë“œ ì‹¤íŒ¨:', err);
      alert('ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    });
}

function closeStudyModal() {
  if (confirm('í•™ìŠµì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
    document.getElementById('studyModal').classList.add('hidden');
    document.getElementById('studyModal').classList.remove('flex');
  }
}

function loadQuestion() {
  const q = questions[currentQuestionIndex];
  
  document.getElementById('currentQuestionNum').textContent = currentQuestionIndex + 1;
  document.getElementById('questionNumber').textContent = q.number || (currentQuestionIndex + 1);
  
  // A: B: í˜•ì‹ì„ ì¤„ë°”ê¿ˆìœ¼ë¡œ í‘œì‹œ
  let questionText = q.question;
  if (questionText.includes('A:') && questionText.includes('B:')) {
    questionText = questionText.replace(' B:', '\nB:');
  }
  document.getElementById('questionText').textContent = questionText;
  
  document.getElementById('answerText').textContent = q.correct_word;
  document.getElementById('hintText').textContent = q.meaning || 'ì˜ë¯¸ ì •ë³´ ì—†ìŒ';
  
  // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
  document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
  
  // ë§ˆì§€ë§‰ ë¬¸ì œì¸ ê²½ìš°
  if (currentQuestionIndex === questions.length - 1) {
    document.getElementById('nextBtn').classList.add('hidden');
    document.getElementById('submitBtn').classList.remove('hidden');
  } else {
    document.getElementById('nextBtn').classList.remove('hidden');
    document.getElementById('submitBtn').classList.add('hidden');
  }
  
  // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
  const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
  document.getElementById('progressBar').style.width = `${progress}%`;
}

function prevQuestion() {
  if (currentQuestionIndex > 0) {
    currentQuestionIndex--;
    loadQuestion();
  }
}

function nextQuestion() {
  if (currentQuestionIndex < questions.length - 1) {
    currentQuestionIndex++;
    loadQuestion();
  }
}

function completeStudy() {
  // ê²°ê³¼ ëª¨ë‹¬ í‘œì‹œ
  document.getElementById('resultTotal').textContent = questions.length;
  
  // í•™ìŠµ ëª¨ë‹¬ ë‹«ê³  ê²°ê³¼ ëª¨ë‹¬ ì—´ê¸°
  document.getElementById('studyModal').classList.add('hidden');
  document.getElementById('studyModal').classList.remove('flex');
  
  document.getElementById('resultModal').classList.remove('hidden');
  document.getElementById('resultModal').classList.add('flex');
}

function closeResultModal() {
  document.getElementById('resultModal').classList.add('hidden');
  document.getElementById('resultModal').classList.remove('flex');
}

function retryStudy() {
  closeResultModal();
  startStudy();
}

// ========================================
// ë¬¸ì œ ê´€ë¦¬
// ========================================

function openQuestionManager() {
  document.getElementById('managerModal').classList.remove('hidden');
  document.getElementById('managerModal').classList.add('flex');
  loadQuestionList();
}

function closeQuestionManager() {
  document.getElementById('managerModal').classList.add('hidden');
  document.getElementById('managerModal').classList.remove('flex');
}

function loadQuestionList() {
  const filterCategory = document.getElementById('managerCategorySelector').value;
  
  const url = filterCategory 
    ? `/api/study_questions?category=${encodeURIComponent(filterCategory)}`
    : '/api/study_questions';
  
  fetch(url)
    .then(res => res.json())
    .then(data => {
      const tbody = document.getElementById('questionListTable');
      tbody.innerHTML = '';
      
      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="border px-3 py-4 text-center text-gray-500">ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
        return;
      }
      
      data.forEach(q => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50';
        tr.innerHTML = `
          <td class="border px-3 py-2 text-center">${q.number || '-'}</td>
          <td class="border px-3 py-2">${q.category || '-'}</td>
          <td class="border px-3 py-2 max-w-md truncate" title="${q.question}">${q.question}</td>
          <td class="border px-3 py-2 font-semibold text-blue-600">${q.correct_word}</td>
          <td class="border px-3 py-2 text-center">
            <button onclick="editQuestion(${q.id})" class="text-blue-600 hover:text-blue-800 text-sm mr-2">ìˆ˜ì •</button>
            <button onclick="deleteQuestion(${q.id})" class="text-red-600 hover:text-red-800 text-sm">ì‚­ì œ</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    })
    .catch(err => {
      console.error('ë¬¸ì œ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', err);
      alert('ë¬¸ì œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    });
}

function openAddQuestionModal() {
  document.getElementById('questionFormTitle').textContent = 'ë¬¸ì œ ì¶”ê°€';
  document.getElementById('questionId').value = '';
  document.getElementById('formCategory').value = '';
  document.getElementById('formNumber').value = '';
  document.getElementById('formQuestion').value = '';
  document.getElementById('formCorrectWord').value = '';
  document.getElementById('formMeaning').value = '';
  
  document.getElementById('questionFormModal').classList.remove('hidden');
  document.getElementById('questionFormModal').classList.add('flex');
}

function closeQuestionFormModal() {
  document.getElementById('questionFormModal').classList.add('hidden');
  document.getElementById('questionFormModal').classList.remove('flex');
}

function saveQuestion() {
  const questionId = document.getElementById('questionId').value;
  const category = document.getElementById('formCategory').value.trim();
  const number = document.getElementById('formNumber').value;
  const question = document.getElementById('formQuestion').value.trim();
  const correctWord = document.getElementById('formCorrectWord').value.trim();
  const meaning = document.getElementById('formMeaning').value.trim();
  
  if (!question || !correctWord) {
    alert('ë¬¸ì œì™€ ì •ë‹µì€ í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤.');
    return;
  }
  
  const data = {
    category,
    number: number ? parseInt(number) : null,
    question,
    correct_word: correctWord,
    meaning
  };
  
  const isEdit = !!questionId;
  const url = isEdit ? `/api/study_questions/${questionId}` : '/api/study_questions';
  const method = isEdit ? 'PUT' : 'POST';
  
  fetch(url, {
    method,
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  })
  .then(res => res.json())
  .then(result => {
    if (result.ok) {
      alert(result.message);
      closeQuestionFormModal();
      loadQuestionList();
    } else {
      alert('ì˜¤ë¥˜: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
    }
  })
  .catch(err => {
    console.error('ì €ì¥ ì‹¤íŒ¨:', err);
    alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  });
}

function editQuestion(questionId) {
  fetch(`/api/study_questions/${questionId}`)
    .then(res => res.json())
    .then(q => {
      document.getElementById('questionFormTitle').textContent = 'ë¬¸ì œ ìˆ˜ì •';
      document.getElementById('questionId').value = q.id;
      document.getElementById('formCategory').value = q.category || '';
      document.getElementById('formNumber').value = q.number || '';
      document.getElementById('formQuestion').value = q.question;
      document.getElementById('formCorrectWord').value = q.correct_word;
      document.getElementById('formMeaning').value = q.meaning || '';
      
      document.getElementById('questionFormModal').classList.remove('hidden');
      document.getElementById('questionFormModal').classList.add('flex');
    })
    .catch(err => {
      console.error('ë¬¸ì œ ë¡œë“œ ì‹¤íŒ¨:', err);
      alert('ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    });
}

function deleteQuestion(questionId) {
  if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  
  fetch(`/api/study_questions/${questionId}`, {
    method: 'DELETE'
  })
  .then(res => res.json())
  .then(result => {
    if (result.ok) {
      alert(result.message);
      loadQuestionList();
    } else {
      alert('ì˜¤ë¥˜: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
    }
  })
  .catch(err => {
    console.error('ì‚­ì œ ì‹¤íŒ¨:', err);
    alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  });
}

// ========================================
// ì¼ê´„ ì¶”ê°€
// ========================================

function openBulkPasteModal() {
  document.getElementById('bulkPasteModal').classList.remove('hidden');
  document.getElementById('bulkPasteModal').classList.add('flex');
  document.getElementById('bulkPasteArea').value = '';
  document.getElementById('bulkPreviewContainer').classList.add('hidden');
  bulkQuestionsData = [];
}

function closeBulkPasteModal() {
  document.getElementById('bulkPasteModal').classList.add('hidden');
  document.getElementById('bulkPasteModal').classList.remove('flex');
}

function previewBulkData() {
  const pasteArea = document.getElementById('bulkPasteArea').value.trim();
  
  if (!pasteArea) {
    alert('ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ì–´ì£¼ì„¸ìš”.');
    return;
  }
  
  const lines = pasteArea.split('\n').filter(line => line.trim());
  bulkQuestionsData = [];
  
  lines.forEach(line => {
    const parts = line.split('\t');
    
    if (parts.length >= 3) {
      const questionData = {
        category: parts[0]?.trim() || '',
        number: parts[1]?.trim() || '',
        question: parts[2]?.trim() || '',
        correct_word: parts[3]?.trim() || '',
        meaning: parts[4]?.trim() || ''
      };
      
      bulkQuestionsData.push(questionData);
    }
  });
  
  const previewTable = document.getElementById('bulkPreviewTable');
  previewTable.innerHTML = '';
  
  if (bulkQuestionsData.length === 0) {
    alert('ì˜¬ë°”ë¥¸ ë°ì´í„° í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.\níƒ­(Tab)ìœ¼ë¡œ êµ¬ë¶„ëœ ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ì–´ì£¼ì„¸ìš”.');
    return;
  }
  
  bulkQuestionsData.forEach(q => {
    const tr = document.createElement('tr');
    tr.className = 'hover:bg-gray-50';
    tr.innerHTML = `
      <td class="border px-2 py-1">${q.category}</td>
      <td class="border px-2 py-1">${q.number}</td>
      <td class="border px-2 py-1 max-w-xs truncate" title="${q.question}">${q.question}</td>
      <td class="border px-2 py-1 font-semibold">${q.correct_word}</td>
      <td class="border px-2 py-1">${q.meaning}</td>
    `;
    previewTable.appendChild(tr);
  });
  
  document.getElementById('previewCount').textContent = bulkQuestionsData.length;
  document.getElementById('bulkPreviewContainer').classList.remove('hidden');
}

function submitBulkQuestions() {
  if (bulkQuestionsData.length === 0) {
    alert('ë¨¼ì € ë¯¸ë¦¬ë³´ê¸°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  if (!confirm(`${bulkQuestionsData.length}ê°œì˜ ë¬¸ì œë¥¼ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
    return;
  }
  
  fetch('/api/study_questions/bulk', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ questions: bulkQuestionsData })
  })
  .then(res => res.json())
  .then(result => {
    if (result.ok) {
      alert(result.message);
      closeBulkPasteModal();
      loadQuestionList();
    } else {
      alert('ì˜¤ë¥˜: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
    }
  })
  .catch(err => {
    console.error('ì¼ê´„ ì €ì¥ ì‹¤íŒ¨:', err);
    alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  });
}
</script>

{% endblock %}
