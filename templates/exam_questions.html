{% extends "base.html" %}
{% block content %}

<h2 class="text-2xl font-semibold mb-6 text-gray-800">ë¬¸ì œ í’€ê¸° & í•™ìŠµí•˜ê¸°</h2>

<!-- ëª¨ë“œ ì„ íƒ -->
<div class="mb-6">
  <label class="block mb-2 text-gray-700 font-medium">ëª¨ë“œ ì„ íƒ</label>
  <div class="flex gap-3">
    <button id="examModeBtn" onclick="switchMode('exam')" class="px-6 py-2 rounded-lg font-semibold transition bg-blue-600 text-white">
      ğŸ“ ì‹œí—˜ ëª¨ë“œ
    </button>
    <button id="studyModeBtn" onclick="switchMode('study')" class="px-6 py-2 rounded-lg font-semibold transition bg-gray-300 text-gray-700 hover:bg-gray-400">
      ğŸ“š í•™ìŠµ ëª¨ë“œ
    </button>
  </div>
  <p class="text-sm text-gray-500 mt-2" id="modeDescription">ì‹œí—˜ ëª¨ë“œ: ê°ê´€ì‹ ë¬¸ì œë¥¼ í’€ê³  ì±„ì í•©ë‹ˆë‹¤</p>
</div>

<!-- ì¹´í…Œê³ ë¦¬ ì„ íƒ -->
<div class="mb-6">
  <label class="block mb-2 text-gray-700 font-medium">ì¹´í…Œê³ ë¦¬ ì„ íƒ</label>
  <select id="categorySelector" class="border rounded px-3 py-2 w-full max-w-md">
    <option value="">ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
    {% for category in categories %}
      <option value="{{ category }}">{{ category }}</option>
    {% endfor %}
  </select>
</div>

<!-- ì‹œì‘ ë²„íŠ¼ -->
<div class="mb-6 flex gap-3">
  <button onclick="startSession()" id="startBtn" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition font-semibold">
    ì‹œì‘í•˜ê¸°
  </button>
  <button onclick="printStudyMaterial()" id="printBtn" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition font-semibold hidden">
    ğŸ–¨ï¸ ì¶œë ¥
  </button>
  <button onclick="openQuestionManager()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition font-semibold">
    ë¬¸ì œ ê´€ë¦¬
  </button>
</div>

<!-- ë¬¸ì œ í’€ê¸°/í•™ìŠµí•˜ê¸° ëª¨ë‹¬ -->
<div id="examModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
  <div class="bg-white rounded-2xl shadow-2xl w-[900px] max-h-[90vh] overflow-y-auto p-8 relative">
    <!-- í—¤ë” -->
    <div class="flex justify-between items-center mb-6 border-b pb-4">
      <div>
        <h2 class="text-2xl font-bold text-gray-800" id="modalTitle">ë¬¸ì œ í’€ê¸°</h2>
        <p class="text-sm text-gray-500 mt-1">ë¬¸ì œ: <span id="currentQuestionNum">1</span> / <span id="totalQuestions">0</span></p>
      </div>
      <button onclick="closeExamModal()" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
    </div>

    <!-- ì§„í–‰ë¥  ë°” -->
    <div class="mb-6">
      <div class="w-full bg-gray-200 rounded-full h-2">
        <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
      </div>
    </div>

    <!-- ë¬¸ì œ ì˜ì—­ -->
    <div id="questionContainer" class="mb-6">
      <div class="bg-blue-50 border-l-4 border-blue-600 p-6 mb-6 rounded">
        <p class="text-sm text-blue-800 font-semibold mb-2">ë¬¸ì œ <span id="questionNumber"></span></p>
        <p id="questionText" class="text-lg text-gray-800 font-medium leading-relaxed whitespace-pre-line"></p>
      </div>

      <!-- ë³´ê¸° (ì‹œí—˜ ëª¨ë“œ) -->
      <div id="choicesContainer" class="space-y-3">
        <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
      </div>

      <!-- ì •ë‹µ & íŒíŠ¸ (í•™ìŠµ ëª¨ë“œ) -->
      <div id="studyAnswerContainer" class="hidden">
        <div class="bg-green-50 border-l-4 border-green-600 p-6 mb-4 rounded">
          <p class="text-sm text-green-800 font-semibold mb-2">ì •ë‹µ</p>
          <p id="answerText" class="text-xl text-gray-800 font-bold"></p>
        </div>
        <div class="bg-yellow-50 border-l-4 border-yellow-600 p-6 rounded">
          <p class="text-sm text-yellow-800 font-semibold mb-2">íŒíŠ¸ / ì˜ë¯¸</p>
          <p id="hintText" class="text-lg text-gray-700"></p>
        </div>
      </div>
    </div>

    <!-- ë‹¤ìŒ/ì œì¶œ ë²„íŠ¼ -->
    <div class="flex justify-between items-center mt-8 pt-4 border-t">
      <button onclick="prevQuestion()" id="prevBtn" class="bg-gray-500 text-white px-6 py-2 rounded hover:bg-gray-600 transition" disabled>
        ì´ì „
      </button>
      <button onclick="nextQuestion()" id="nextBtn" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition">
        ë‹¤ìŒ
      </button>
      <button onclick="submitExam()" id="submitBtn" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 transition hidden">
        ì œì¶œ
      </button>
      <button onclick="completeStudy()" id="completeStudyBtn" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 transition hidden">
        í•™ìŠµ ì™„ë£Œ
      </button>
    </div>
  </div>
</div>

<!-- ê²°ê³¼ ëª¨ë‹¬ -->
<div id="resultModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
  <div class="bg-white rounded-2xl shadow-2xl w-[700px] p-8 relative">
    <div class="text-center">
      <div class="mb-6">
        <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-10 h-10 text-green-600" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
          </svg>
        </div>
        <h2 class="text-3xl font-bold text-gray-800 mb-2">ì‹œí—˜ ì™„ë£Œ!</h2>
        <p class="text-gray-600">ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤</p>
      </div>

      <div class="bg-blue-50 rounded-lg p-6 mb-6">
        <div class="grid grid-cols-3 gap-4 text-center">
          <div>
            <p class="text-sm text-gray-600 mb-1">ì´ ë¬¸ì œ</p>
            <p class="text-2xl font-bold text-blue-600"><span id="resultTotal">0</span>ê°œ</p>
          </div>
          <div>
            <p class="text-sm text-gray-600 mb-1">ì •ë‹µ</p>
            <p class="text-2xl font-bold text-green-600"><span id="resultCorrect">0</span>ê°œ</p>
          </div>
          <div>
            <p class="text-sm text-gray-600 mb-1">ì ìˆ˜</p>
            <p class="text-2xl font-bold text-purple-600"><span id="resultScore">0</span>ì </p>
          </div>
        </div>
      </div>

      <!-- ì˜¤ë‹µ ëª©ë¡ -->
      <div id="wrongAnswersContainer" class="text-left mb-6 max-h-60 overflow-y-auto">
        <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
      </div>

      <div class="flex justify-center space-x-3">
        <button onclick="closeResultModal()" class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition font-semibold">
          í™•ì¸
        </button>
        <button onclick="retryExam()" class="bg-gray-500 text-white px-8 py-3 rounded-lg hover:bg-gray-600 transition font-semibold">
          ë‹¤ì‹œ í’€ê¸°
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ë¬¸ì œ ê´€ë¦¬ ëª¨ë‹¬ -->
<div id="managerModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
  <div class="bg-white rounded-2xl shadow-2xl w-[1000px] max-h-[90vh] overflow-y-auto p-8 relative">
    <div class="flex justify-between items-center mb-6 border-b pb-4">
      <h2 class="text-2xl font-bold text-gray-800">ë¬¸ì œ ê´€ë¦¬</h2>
      <button onclick="closeQuestionManager()" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
    </div>

    <!-- ì¹´í…Œê³ ë¦¬ í•„í„° & ì¶”ê°€ ë²„íŠ¼ -->
    <div class="flex justify-between items-center mb-4">
      <div class="flex gap-3 items-center">
        <label class="text-sm font-medium text-gray-700">ì¹´í…Œê³ ë¦¬:</label>
        <select id="managerCategorySelector" onchange="loadQuestionList()" class="border rounded px-3 py-2">
          <option value="">ì „ì²´</option>
          {% for category in categories %}
            <option value="{{ category }}">{{ category }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="flex gap-2">
        <button onclick="openBulkPasteModal()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition font-semibold">
          ğŸ“‹ ì—‘ì…€ ë¶™ì—¬ë„£ê¸°
        </button>
        <button onclick="openAddQuestionModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition font-semibold">
          + ë¬¸ì œ ì¶”ê°€
        </button>
      </div>
    </div>

    <!-- ë¬¸ì œ ëª©ë¡ í…Œì´ë¸” -->
    <div class="overflow-x-auto">
      <table class="w-full text-sm border-collapse bg-white shadow-sm rounded-lg">
        <thead>
          <tr class="bg-gradient-to-r from-purple-100 to-indigo-100">
            <th class="border px-3 py-2 text-center font-semibold text-gray-700" style="width: 60px;">ë²ˆí˜¸</th>
            <th class="border px-3 py-2 text-left font-semibold text-gray-700" style="width: 120px;">ì¹´í…Œê³ ë¦¬</th>
            <th class="border px-3 py-2 text-left font-semibold text-gray-700">ë¬¸ì œ</th>
            <th class="border px-3 py-2 text-center font-semibold text-gray-700" style="width: 120px;">ì‘ì—…</th>
          </tr>
        </thead>
        <tbody id="questionListTable">
          <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤ -->
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- ë¬¸ì œ ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
<div id="questionFormModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
  <div class="bg-white rounded-2xl shadow-2xl w-[700px] max-h-[90vh] overflow-y-auto p-8 relative">
    <div class="flex justify-between items-center mb-6 border-b pb-4">
      <h2 id="questionFormTitle" class="text-2xl font-bold text-gray-800">ë¬¸ì œ ì¶”ê°€</h2>
      <button onclick="closeQuestionFormModal()" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
    </div>

    <form id="questionForm" onsubmit="event.preventDefault(); saveQuestion();">
      <input type="hidden" id="questionId">
      
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">ì¹´í…Œê³ ë¦¬</label>
          <input id="formCategory" type="text" class="w-full border rounded px-3 py-2" placeholder="ì˜ˆ: TOEFL" required>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">ë²ˆí˜¸</label>
          <input id="formNumber" type="number" class="w-full border rounded px-3 py-2" placeholder="1">
        </div>
      </div>

      <div class="mb-4">
        <label class="block text-sm font-semibold text-gray-700 mb-1">ë¬¸ì œ *</label>
        <textarea id="formQuestion" rows="4" class="w-full border rounded px-3 py-2" placeholder="ë¬¸ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”" required></textarea>
      </div>

      <div class="mb-4">
        <label class="block text-sm font-semibold text-gray-700 mb-1">ë³´ê¸° A</label>
        <input id="formChoiceA" type="text" class="w-full border rounded px-3 py-2" placeholder="ë³´ê¸° A">
      </div>

      <div class="mb-4">
        <label class="block text-sm font-semibold text-gray-700 mb-1">ë³´ê¸° B</label>
        <input id="formChoiceB" type="text" class="w-full border rounded px-3 py-2" placeholder="ë³´ê¸° B">
      </div>

      <div class="mb-4">
        <label class="block text-sm font-semibold text-gray-700 mb-1">ë³´ê¸° C</label>
        <input id="formChoiceC" type="text" class="w-full border rounded px-3 py-2" placeholder="ë³´ê¸° C">
      </div>

      <div class="mb-4">
        <label class="block text-sm font-semibold text-gray-700 mb-1">ë³´ê¸° D</label>
        <input id="formChoiceD" type="text" class="w-full border rounded px-3 py-2" placeholder="ë³´ê¸° D">
      </div>

      <div class="mb-6">
        <label class="block text-sm font-semibold text-gray-700 mb-1">ì •ë‹µ *</label>
        <select id="formAnswer" class="w-full border rounded px-3 py-2" required>
          <option value="">ì •ë‹µ ì„ íƒ</option>
          <option value="A">A</option>
          <option value="B">B</option>
          <option value="C">C</option>
          <option value="D">D</option>
        </select>
      </div>

      <div class="flex justify-end space-x-3">
        <button type="button" onclick="closeQuestionFormModal()" class="px-6 py-2 bg-gray-300 rounded hover:bg-gray-400">ì·¨ì†Œ</button>
        <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">ì €ì¥</button>
      </div>
    </form>
  </div>
</div>

<!-- ì—‘ì…€ ë°ì´í„° ë¶™ì—¬ë„£ê¸° ëª¨ë‹¬ -->
<div id="bulkPasteModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
  <div class="bg-white rounded-2xl shadow-2xl w-[900px] max-h-[90vh] overflow-y-auto p-8 relative">
    <div class="flex justify-between items-center mb-6 border-b pb-4">
      <div>
        <h2 class="text-2xl font-bold text-gray-800">ì—‘ì…€ ë°ì´í„° ë¶™ì—¬ë„£ê¸°</h2>
        <p class="text-sm text-gray-500 mt-1">ì—‘ì…€ì—ì„œ ë³µì‚¬í•œ ë°ì´í„°ë¥¼ ì•„ë˜ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”</p>
      </div>
      <button onclick="closeBulkPasteModal()" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
    </div>

    <!-- ì•ˆë‚´ ë¬¸êµ¬ -->
    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
      <p class="text-sm text-blue-800 font-semibold mb-2">ğŸ“‹ ë°ì´í„° í˜•ì‹ ì•ˆë‚´</p>
      <p class="text-sm text-gray-700">ì—‘ì…€ì—ì„œ ë‹¤ìŒ ìˆœì„œë¡œ ë°ì´í„°ë¥¼ ë³µì‚¬í•˜ì„¸ìš”:</p>
      <p class="text-sm text-gray-700 font-mono mt-1">ì¹´í…Œê³ ë¦¬ &nbsp;&nbsp; ë²ˆí˜¸ &nbsp;&nbsp; ë¬¸ì œ &nbsp;&nbsp; ë³´ê¸°A &nbsp;&nbsp; ë³´ê¸°B &nbsp;&nbsp; ë³´ê¸°C &nbsp;&nbsp; ë³´ê¸°D &nbsp;&nbsp; ì •ë‹µ</p>
      <p class="text-sm text-gray-500 mt-2">â€» íƒ­(Tab)ìœ¼ë¡œ êµ¬ë¶„ëœ ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ìœ¼ë©´ ìë™ìœ¼ë¡œ íŒŒì‹±ë©ë‹ˆë‹¤.</p>
    </div>

    <!-- ë¶™ì—¬ë„£ê¸° ì˜ì—­ -->
    <div class="mb-4">
      <label class="block text-sm font-semibold text-gray-700 mb-2">ì—‘ì…€ ë°ì´í„° ë¶™ì—¬ë„£ê¸°</label>
      <textarea id="bulkPasteArea" rows="10" class="w-full border rounded-lg p-3 font-mono text-sm" 
        placeholder="ì—‘ì…€ì—ì„œ ë³µì‚¬í•œ ë°ì´í„°ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”...&#10;&#10;ì˜ˆì‹œ:&#10;TOEFL	1	What is the main idea?	option1	option2	option3	option4	A&#10;TOEFL	2	Choose the correct answer	choice1	choice2	choice3	choice4	B"></textarea>
    </div>

    <!-- ë¯¸ë¦¬ë³´ê¸° -->
    <div class="mb-4">
      <button onclick="previewBulkData()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
        ë¯¸ë¦¬ë³´ê¸°
      </button>
    </div>

    <div id="bulkPreviewContainer" class="mb-4 hidden">
      <h3 class="text-sm font-semibold text-gray-700 mb-2">ë¯¸ë¦¬ë³´ê¸° (<span id="previewCount">0</span>ê°œ ë¬¸ì œ)</h3>
      <div class="max-h-64 overflow-y-auto border rounded-lg">
        <table class="w-full text-xs">
          <thead class="bg-gray-100 sticky top-0">
            <tr>
              <th class="border px-2 py-1">ì¹´í…Œê³ ë¦¬</th>
              <th class="border px-2 py-1">ë²ˆí˜¸</th>
              <th class="border px-2 py-1">ë¬¸ì œ</th>
              <th class="border px-2 py-1">A</th>
              <th class="border px-2 py-1">B</th>
              <th class="border px-2 py-1">C</th>
              <th class="border px-2 py-1">D</th>
              <th class="border px-2 py-1">ì •ë‹µ</th>
            </tr>
          </thead>
          <tbody id="bulkPreviewTable">
          </tbody>
        </table>
      </div>
    </div>

    <div class="flex justify-end space-x-3">
      <button onclick="closeBulkPasteModal()" class="px-6 py-2 bg-gray-300 rounded hover:bg-gray-400">ì·¨ì†Œ</button>
      <button onclick="submitBulkQuestions()" class="px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700">ì¼ê´„ ì €ì¥</button>
    </div>
  </div>
</div>

<script>
let questions = [];
let currentQuestionIndex = 0;
let userAnswers = [];
let selectedCategory = '';
let bulkQuestionsData = [];
let currentMode = 'exam'; // 'exam' or 'study'

// ëª¨ë“œ ì „í™˜
function switchMode(mode) {
  currentMode = mode;
  
  const examBtn = document.getElementById('examModeBtn');
  const studyBtn = document.getElementById('studyModeBtn');
  const modeDesc = document.getElementById('modeDescription');
  const printBtn = document.getElementById('printBtn');
  
  if (mode === 'exam') {
    examBtn.className = 'px-6 py-2 rounded-lg font-semibold transition bg-blue-600 text-white';
    studyBtn.className = 'px-6 py-2 rounded-lg font-semibold transition bg-gray-300 text-gray-700 hover:bg-gray-400';
    modeDesc.textContent = 'ì‹œí—˜ ëª¨ë“œ: ê°ê´€ì‹ ë¬¸ì œë¥¼ í’€ê³  ì±„ì í•©ë‹ˆë‹¤';
    printBtn.classList.add('hidden');
  } else {
    examBtn.className = 'px-6 py-2 rounded-lg font-semibold transition bg-gray-300 text-gray-700 hover:bg-gray-400';
    studyBtn.className = 'px-6 py-2 rounded-lg font-semibold transition bg-purple-600 text-white';
    modeDesc.textContent = 'í•™ìŠµ ëª¨ë“œ: ì •ë‹µê³¼ íŒíŠ¸ë¥¼ ë³´ë©° í•™ìŠµí•©ë‹ˆë‹¤';
    printBtn.classList.remove('hidden');
  }
}

// ì„¸ì…˜ ì‹œì‘ (í†µí•©)
function startSession() {
  if (currentMode === 'exam') {
    startExam();
  } else {
    startStudy();
  }
}

// í•™ìŠµ ëª¨ë“œ ì‹œì‘
function startStudy() {
  selectedCategory = document.getElementById('categorySelector').value;
  
  if (!selectedCategory) {
    alert('ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
    return;
  }

  // í•™ìŠµ ë¬¸ì œ ë¶ˆëŸ¬ì˜¤ê¸°
  fetch(`/api/study_questions?category=${encodeURIComponent(selectedCategory)}`)
    .then(res => res.json())
    .then(data => {
      if (data.length === 0) {
        alert('ì„ íƒí•œ ì¹´í…Œê³ ë¦¬ì— í•™ìŠµ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      questions = data;
      currentQuestionIndex = 0;
      
      // ëª¨ë‹¬ í‘œì‹œ
      document.getElementById('modalTitle').textContent = 'í•™ìŠµí•˜ê¸°';
      document.getElementById('examModal').classList.remove('hidden');
      document.getElementById('examModal').classList.add('flex');
      
      // ì²« ë¬¸ì œ í‘œì‹œ
      displayStudyQuestion();
    })
    .catch(err => {
      console.error('í•™ìŠµ ë¬¸ì œ ë¡œë“œ ì‹¤íŒ¨:', err);
      alert('í•™ìŠµ ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    });
}

// í•™ìŠµ ë¬¸ì œ í‘œì‹œ
function displayStudyQuestion() {
  if (questions.length === 0) return;
  
  const question = questions[currentQuestionIndex];
  
  // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
  const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
  document.getElementById('progressBar').style.width = progress + '%';
  
  // ë¬¸ì œ ë²ˆí˜¸
  document.getElementById('currentQuestionNum').textContent = currentQuestionIndex + 1;
  document.getElementById('totalQuestions').textContent = questions.length;
  document.getElementById('questionNumber').textContent = currentQuestionIndex + 1;
  
  // ë¬¸ì œ í…ìŠ¤íŠ¸ (ëŒ€í™”ë¬¸ ì¤„ë°”ê¿ˆ ì²˜ë¦¬)
  let questionText = question.question;
  if (questionText.includes('A:') && questionText.includes('B:')) {
    questionText = questionText.replace(' B:', '\nB:');
  }
  document.getElementById('questionText').textContent = questionText;
  
  // ì •ë‹µ & íŒíŠ¸ í‘œì‹œ
  document.getElementById('answerText').textContent = question.correct_word;
  document.getElementById('hintText').textContent = question.meaning || 'ì˜ë¯¸ ì •ë³´ ì—†ìŒ';
  
  // UI ì „í™˜
  document.getElementById('choicesContainer').classList.add('hidden');
  document.getElementById('studyAnswerContainer').classList.remove('hidden');
  document.getElementById('submitBtn').classList.add('hidden');
  document.getElementById('completeStudyBtn').classList.remove('hidden');
  
  // ë²„íŠ¼ ìƒíƒœ
  document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
  
  if (currentQuestionIndex === questions.length - 1) {
    document.getElementById('nextBtn').classList.add('hidden');
    document.getElementById('completeStudyBtn').classList.remove('hidden');
  } else {
    document.getElementById('nextBtn').classList.remove('hidden');
    document.getElementById('completeStudyBtn').classList.add('hidden');
  }
}

// í•™ìŠµ ì™„ë£Œ
function completeStudy() {
  alert(`${questions.length}ê°œ ë¬¸ì œ í•™ìŠµì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤! ğŸ‰`);
  closeExamModal();
}

// ì—‘ì…€ ë¶™ì—¬ë„£ê¸° ëª¨ë‹¬ ì—´ê¸°
function openBulkPasteModal() {
  document.getElementById('bulkPasteModal').classList.remove('hidden');
  document.getElementById('bulkPasteModal').classList.add('flex');
  document.getElementById('bulkPasteArea').value = '';
  document.getElementById('bulkPreviewContainer').classList.add('hidden');
  bulkQuestionsData = [];
}

function closeBulkPasteModal() {
  document.getElementById('bulkPasteModal').classList.add('hidden');
  document.getElementById('bulkPasteModal').classList.remove('flex');
}

// ì—‘ì…€ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°
function previewBulkData() {
  const pasteArea = document.getElementById('bulkPasteArea').value.trim();
  
  if (!pasteArea) {
    alert('ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ì–´ì£¼ì„¸ìš”.');
    return;
  }
  
  // ì¤„ ë‹¨ìœ„ë¡œ ë¶„ë¦¬
  const lines = pasteArea.split('\n').filter(line => line.trim());
  bulkQuestionsData = [];
  
  lines.forEach((line, index) => {
    // íƒ­ìœ¼ë¡œ ë¶„ë¦¬
    const parts = line.split('\t');
    
    if (parts.length >= 3) { // ìµœì†Œ ì¹´í…Œê³ ë¦¬, ë²ˆí˜¸, ë¬¸ì œëŠ” ìˆì–´ì•¼ í•¨
      const questionData = {
        category: parts[0]?.trim() || '',
        number: parts[1]?.trim() || '',
        question: parts[2]?.trim() || '',
        choice_a: parts[3]?.trim() || '',
        choice_b: parts[4]?.trim() || '',
        choice_c: parts[5]?.trim() || '',
        choice_d: parts[6]?.trim() || '',
        answer: parts[7]?.trim().toUpperCase() || ''
      };
      
      bulkQuestionsData.push(questionData);
    }
  });
  
  // ë¯¸ë¦¬ë³´ê¸° í…Œì´ë¸” ìƒì„±
  const previewTable = document.getElementById('bulkPreviewTable');
  previewTable.innerHTML = '';
  
  if (bulkQuestionsData.length === 0) {
    alert('ì˜¬ë°”ë¥¸ ë°ì´í„° í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.\níƒ­(Tab)ìœ¼ë¡œ êµ¬ë¶„ëœ ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ì–´ì£¼ì„¸ìš”.');
    return;
  }
  
  bulkQuestionsData.forEach((q, index) => {
    const tr = document.createElement('tr');
    tr.className = 'hover:bg-gray-50';
    tr.innerHTML = `
      <td class="border px-2 py-1">${q.category}</td>
      <td class="border px-2 py-1">${q.number}</td>
      <td class="border px-2 py-1 max-w-xs truncate" title="${q.question}">${q.question}</td>
      <td class="border px-2 py-1 max-w-xs truncate" title="${q.choice_a}">${q.choice_a}</td>
      <td class="border px-2 py-1 max-w-xs truncate" title="${q.choice_b}">${q.choice_b}</td>
      <td class="border px-2 py-1 max-w-xs truncate" title="${q.choice_c}">${q.choice_c}</td>
      <td class="border px-2 py-1 max-w-xs truncate" title="${q.choice_d}">${q.choice_d}</td>
      <td class="border px-2 py-1 font-semibold text-center">${q.answer}</td>
    `;
    previewTable.appendChild(tr);
  });
  
  document.getElementById('previewCount').textContent = bulkQuestionsData.length;
  document.getElementById('bulkPreviewContainer').classList.remove('hidden');
}

// ì¼ê´„ ì €ì¥
function submitBulkQuestions() {
  if (bulkQuestionsData.length === 0) {
    alert('ë¨¼ì € ë¯¸ë¦¬ë³´ê¸°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  if (!confirm(`${bulkQuestionsData.length}ê°œì˜ ë¬¸ì œë¥¼ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
    return;
  }
  
  // API í˜¸ì¶œ
  fetch('/api/exam_questions/bulk', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ questions: bulkQuestionsData })
  })
  .then(res => res.json())
  .then(result => {
    if (result.ok) {
      alert(`${result.count || bulkQuestionsData.length}ê°œì˜ ë¬¸ì œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      closeBulkPasteModal();
      loadQuestionList();
    } else {
      alert('ì˜¤ë¥˜: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
    }
  })
  .catch(err => {
    console.error('ì¼ê´„ ì €ì¥ ì‹¤íŒ¨:', err);
    alert('ë¬¸ì œ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  });
}

// ì‹œí—˜ ì‹œì‘
function startExam() {
  selectedCategory = document.getElementById('categorySelector').value;
  
  if (!selectedCategory) {
    alert('ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
    return;
  }

  // ë¬¸ì œ ë¶ˆëŸ¬ì˜¤ê¸°
  fetch(`/api/exam_questions?category=${encodeURIComponent(selectedCategory)}`)
    .then(res => res.json())
    .then(data => {
      if (data.length === 0) {
        alert('ì„ íƒí•œ ì¹´í…Œê³ ë¦¬ì— ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      questions = data;
      currentQuestionIndex = 0;
      userAnswers = new Array(questions.length).fill(null);
      
      // ëª¨ë‹¬ í‘œì‹œ
      document.getElementById('modalTitle').textContent = 'ë¬¸ì œ í’€ê¸°';
      document.getElementById('examModal').classList.remove('hidden');
      document.getElementById('examModal').classList.add('flex');
      
      // ì²« ë¬¸ì œ í‘œì‹œ
      displayQuestion();
    })
    .catch(err => {
      console.error('ë¬¸ì œ ë¡œë“œ ì‹¤íŒ¨:', err);
      alert('ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    });
}

// ë¬¸ì œ í‘œì‹œ
function displayQuestion() {
  if (questions.length === 0) return;
  
  const question = questions[currentQuestionIndex];
  
  // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
  const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
  document.getElementById('progressBar').style.width = progress + '%';
  
  // ë¬¸ì œ ë²ˆí˜¸
  document.getElementById('currentQuestionNum').textContent = currentQuestionIndex + 1;
  document.getElementById('totalQuestions').textContent = questions.length;
  document.getElementById('questionNumber').textContent = currentQuestionIndex + 1;
  
  // ë¬¸ì œ í…ìŠ¤íŠ¸
  document.getElementById('questionText').textContent = question.question;
  
  // UI ì „í™˜
  document.getElementById('choicesContainer').classList.remove('hidden');
  document.getElementById('studyAnswerContainer').classList.add('hidden');
  document.getElementById('completeStudyBtn').classList.add('hidden');
  
  // ë³´ê¸° ìƒì„±
  const choicesContainer = document.getElementById('choicesContainer');
  choicesContainer.innerHTML = '';
  
  const choices = [
    { label: 'A', text: question.choice_a },
    { label: 'B', text: question.choice_b },
    { label: 'C', text: question.choice_c },
    { label: 'D', text: question.choice_d }
  ];
  
  choices.forEach(choice => {
    if (choice.text) {
      const choiceDiv = document.createElement('div');
      const isSelected = userAnswers[currentQuestionIndex] === choice.label;
      
      choiceDiv.className = `border rounded-lg p-4 cursor-pointer transition hover:bg-blue-50 hover:border-blue-400 ${
        isSelected ? 'bg-blue-100 border-blue-500' : 'bg-white border-gray-300'
      }`;
      choiceDiv.onclick = () => selectAnswer(choice.label);
      
      choiceDiv.innerHTML = `
        <div class="flex items-start">
          <span class="font-bold text-blue-600 mr-3 min-w-[24px]">${choice.label}.</span>
          <span class="text-gray-800">${choice.text}</span>
        </div>
      `;
      
      choicesContainer.appendChild(choiceDiv);
    }
  });
  
  // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
  document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
  
  if (currentQuestionIndex === questions.length - 1) {
    document.getElementById('nextBtn').classList.add('hidden');
    document.getElementById('submitBtn').classList.remove('hidden');
  } else {
    document.getElementById('nextBtn').classList.remove('hidden');
    document.getElementById('submitBtn').classList.add('hidden');
  }
}

// ë‹µì•ˆ ì„ íƒ
function selectAnswer(answer) {
  userAnswers[currentQuestionIndex] = answer;
  displayQuestion(); // ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
}

// ì´ì „ ë¬¸ì œ
function prevQuestion() {
  if (currentQuestionIndex > 0) {
    currentQuestionIndex--;
    if (currentMode === 'study') {
      displayStudyQuestion();
    } else {
      displayQuestion();
    }
  }
}

// ë‹¤ìŒ ë¬¸ì œ
function nextQuestion() {
  if (currentQuestionIndex < questions.length - 1) {
    currentQuestionIndex++;
    if (currentMode === 'study') {
      displayStudyQuestion();
    } else {
      displayQuestion();
    }
  }
}

// ì‹œí—˜ ì œì¶œ
function submitExam() {
  // ë¯¸ì‘ë‹µ ë¬¸ì œ í™•ì¸
  const unanswered = userAnswers.filter(a => a === null).length;
  if (unanswered > 0) {
    if (!confirm(`${unanswered}ê°œ ë¬¸ì œì— ë‹µí•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
      return;
    }
  }
  
  // ì±„ì 
  let correctCount = 0;
  const wrongAnswers = [];
  
  questions.forEach((q, index) => {
    const userAnswer = userAnswers[index];
    const correctAnswer = q.answer;
    
    if (userAnswer && userAnswer.toUpperCase() === correctAnswer.toUpperCase()) {
      correctCount++;
    } else {
      wrongAnswers.push({
        number: index + 1,
        question: q.question,
        userAnswer: userAnswer || 'ë¯¸ì‘ë‹µ',
        correctAnswer: correctAnswer
      });
    }
  });
  
  const score = Math.round((correctCount / questions.length) * 100);
  
  // ê²°ê³¼ ì €ì¥ (ì„ íƒì‚¬í•­)
  fetch('/api/exam_result', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      category: selectedCategory,
      total_questions: questions.length,
      correct_answers: correctCount
    })
  });
  
  // ê²°ê³¼ í‘œì‹œ
  showResult(questions.length, correctCount, score, wrongAnswers);
}

// ê²°ê³¼ í‘œì‹œ
function showResult(total, correct, score, wrongAnswers) {
  document.getElementById('examModal').classList.add('hidden');
  
  document.getElementById('resultTotal').textContent = total;
  document.getElementById('resultCorrect').textContent = correct;
  document.getElementById('resultScore').textContent = score;
  
  // ì˜¤ë‹µ ëª©ë¡
  const wrongContainer = document.getElementById('wrongAnswersContainer');
  wrongContainer.innerHTML = '';
  
  if (wrongAnswers.length > 0) {
    wrongContainer.innerHTML = '<h3 class="font-semibold text-gray-800 mb-3">í‹€ë¦° ë¬¸ì œ</h3>';
    wrongAnswers.forEach(w => {
      const wrongDiv = document.createElement('div');
      wrongDiv.className = 'bg-red-50 border-l-4 border-red-500 p-3 mb-2 text-sm';
      wrongDiv.innerHTML = `
        <p class="font-semibold text-red-800">ë¬¸ì œ ${w.number}</p>
        <p class="text-gray-700 mb-1">${w.question}</p>
        <p class="text-sm"><span class="text-red-600">ë‚´ ë‹µ: ${w.userAnswer}</span> / <span class="text-green-600">ì •ë‹µ: ${w.correctAnswer}</span></p>
      `;
      wrongContainer.appendChild(wrongDiv);
    });
  } else {
    wrongContainer.innerHTML = '<p class="text-green-600 font-semibold text-center">ëª¨ë“  ë¬¸ì œë¥¼ ë§ì¶”ì…¨ìŠµë‹ˆë‹¤! ğŸ‰</p>';
  }
  
  document.getElementById('resultModal').classList.remove('hidden');
  document.getElementById('resultModal').classList.add('flex');
}

// ëª¨ë‹¬ ë‹«ê¸°
function closeExamModal() {
  const confirmMessage = currentMode === 'study' ? 'í•™ìŠµì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?' : 'ì‹œí—˜ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì§„í–‰ ìƒí™©ì´ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
  if (confirm(confirmMessage)) {
    document.getElementById('examModal').classList.add('hidden');
    document.getElementById('examModal').classList.remove('flex');
  }
}

function closeResultModal() {
  document.getElementById('resultModal').classList.add('hidden');
  document.getElementById('resultModal').classList.remove('flex');
}

// í•™ìŠµ ìë£Œ ì¶œë ¥
function printStudyMaterial() {
  const category = document.getElementById('categorySelector').value;
  
  if (!category) {
    alert('ì¹´í…Œê³ ë¦¬ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.');
    return;
  }
  
  // í•™ìŠµ ë¬¸ì œ ê°€ì ¸ì˜¤ê¸°
  fetch(`/api/study_questions?category=${encodeURIComponent(category)}`)
    .then(res => res.json())
    .then(data => {
      if (data.length === 0) {
        alert('ì„ íƒí•œ ì¹´í…Œê³ ë¦¬ì— í•™ìŠµ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      // ì¸ì‡„ìš© HTML ìƒì„±
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>${category} - í•™ìŠµ ìë£Œ</title>
  <style>
    @media print {
      @page {
        margin: 0.8cm;
      }
      body {
        margin: 0;
        padding: 0;
      }
      .page-break {
        page-break-after: always;
      }
      .no-print {
        display: none;
      }
    }
    
    body {
      font-family: 'Malgun Gothic', sans-serif;
      line-height: 1.4;
      color: #333;
      max-width: 210mm;
      margin: 0 auto;
      padding: 15px;
    }
    
    .header {
      text-align: center;
      border-bottom: 2px solid #4F46E5;
      padding-bottom: 8px;
      margin-bottom: 15px;
    }
    
    .header h1 {
      margin: 0;
      color: #4F46E5;
      font-size: 22px;
    }
    
    .header p {
      margin: 3px 0 0 0;
      color: #666;
      font-size: 11px;
    }
    
    .question-item {
      margin-bottom: 15px;
      padding: 10px;
      border: 1px solid #E5E7EB;
      border-radius: 5px;
      background: #F9FAFB;
      break-inside: avoid;
      page-break-inside: avoid;
    }
    
    .question-number {
      font-weight: bold;
      color: #4F46E5;
      font-size: 14px;
      margin-bottom: 5px;
    }
    
    .question-text {
      font-size: 15px;
      margin-bottom: 8px;
      white-space: pre-line;
      line-height: 1.6;
      font-weight: 500;
    }
    
    .answer-hint-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    
    .answer-section {
      background: #DBEAFE;
      padding: 6px 8px;
      border-radius: 4px;
    }
    
    .answer-label {
      font-weight: bold;
      color: #1E40AF;
      font-size: 10px;
      margin-bottom: 2px;
    }
    
    .answer-text {
      color: #1E3A8A;
      font-size: 13px;
      font-weight: bold;
    }
    
    .hint-section {
      background: #FEF3C7;
      padding: 6px 8px;
      border-radius: 4px;
    }
    
    .hint-label {
      font-weight: bold;
      color: #92400E;
      font-size: 10px;
      margin-bottom: 2px;
    }
    
    .hint-text {
      color: #78350F;
      font-size: 11px;
    }
    
    .footer {
      text-align: center;
      margin-top: 20px;
      padding-top: 10px;
      border-top: 1px solid #E5E7EB;
      color: #9CA3AF;
      font-size: 10px;
    }
    
    .print-button {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #4F46E5;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      z-index: 1000;
    }
    
    .print-button:hover {
      background: #4338CA;
    }
  </style>
</head>
<body>
  <button class="print-button no-print" onclick="window.print()">ğŸ–¨ï¸ ì¸ì‡„í•˜ê¸°</button>
  
  <div class="header">
    <h1>${category}</h1>
    <p>í•™ìŠµ ìë£Œ | ì´ ${data.length}ê°œ ë¬¸ì œ | ì¶œë ¥ì¼: ${new Date().toLocaleDateString('ko-KR')}</p>
  </div>
  
  ${data.map((q, index) => {
    let questionText = q.question;
    // ëŒ€í™”ë¬¸ ì¤„ë°”ê¿ˆ ì²˜ë¦¬
    if (questionText.includes('A:') && questionText.includes('B:')) {
      questionText = questionText.replace(' B:', '\nB:');
    }
    
    return `
    <div class="question-item">
      <div class="question-number">ë¬¸ì œ ${q.number || (index + 1)}</div>
      <div class="question-text">${questionText}</div>
      <div class="answer-hint-container">
        <div class="answer-section">
          <div class="answer-label">âœ“ ì •ë‹µ</div>
          <div class="answer-text">${q.correct_word}</div>
        </div>
        ${q.meaning ? `
        <div class="hint-section">
          <div class="hint-label">ğŸ’¡ íŒíŠ¸</div>
          <div class="hint-text">${q.meaning}</div>
        </div>
        ` : '<div></div>'}
      </div>
    </div>
    `;
  }).join('')}
  
  <div class="footer">
    <p>Word Master - ${category} í•™ìŠµ ìë£Œ</p>
  </div>
</body>
</html>
      `);
      printWindow.document.close();
      
      // ìë™ìœ¼ë¡œ ì¸ì‡„ ëŒ€í™”ìƒì í‘œì‹œ (ì„ íƒì‚¬í•­)
      setTimeout(() => {
        printWindow.focus();
      }, 500);
    })
    .catch(err => {
      console.error('í•™ìŠµ ìë£Œ ë¡œë“œ ì‹¤íŒ¨:', err);
      alert('í•™ìŠµ ìë£Œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    });
}

// ë‹¤ì‹œ í’€ê¸°
function retryExam() {
  closeResultModal();
  startExam();
}

// ë¬¸ì œ ê´€ë¦¬ ëª¨ë‹¬ ì—´ê¸°
function openQuestionManager() {
  document.getElementById('managerModal').classList.remove('hidden');
  document.getElementById('managerModal').classList.add('flex');
  loadQuestionList();
}

function closeQuestionManager() {
  document.getElementById('managerModal').classList.add('hidden');
  document.getElementById('managerModal').classList.remove('flex');
}

// ë¬¸ì œ ëª©ë¡ ë¡œë“œ
function loadQuestionList() {
  const category = document.getElementById('managerCategorySelector').value;
  
  fetch(`/api/exam_questions?category=${encodeURIComponent(category)}`)
    .then(res => res.json())
    .then(data => {
      const tbody = document.getElementById('questionListTable');
      tbody.innerHTML = '';
      
      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="border px-4 py-3 text-center text-gray-500">ë“±ë¡ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }
      
      data.forEach(q => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50';
        tr.innerHTML = `
          <td class="border px-3 py-2 text-center">${q.number || '-'}</td>
          <td class="border px-3 py-2">${q.category || '-'}</td>
          <td class="border px-3 py-2">${q.question}</td>
          <td class="border px-3 py-2 text-center">
            <button onclick="editQuestion(${q.id})" class="bg-blue-500 text-white px-2 py-1 rounded text-xs mr-1 hover:bg-blue-600">ìˆ˜ì •</button>
            <button onclick="deleteQuestion(${q.id})" class="bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600">ì‚­ì œ</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    })
    .catch(err => {
      console.error('ë¬¸ì œ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', err);
      alert('ë¬¸ì œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    });
}

// ë¬¸ì œ ì¶”ê°€ ëª¨ë‹¬ ì—´ê¸°
function openAddQuestionModal() {
  document.getElementById('questionFormModal').classList.remove('hidden');
  document.getElementById('questionFormModal').classList.add('flex');
  document.getElementById('questionFormTitle').textContent = 'ë¬¸ì œ ì¶”ê°€';
  document.getElementById('questionForm').reset();
  document.getElementById('questionId').value = '';
}

function closeQuestionFormModal() {
  document.getElementById('questionFormModal').classList.add('hidden');
  document.getElementById('questionFormModal').classList.remove('flex');
}

// ë¬¸ì œ ì €ì¥
function saveQuestion() {
  const id = document.getElementById('questionId').value;
  const category = document.getElementById('formCategory').value.trim();
  const number = document.getElementById('formNumber').value;
  const question = document.getElementById('formQuestion').value.trim();
  const choice_a = document.getElementById('formChoiceA').value.trim();
  const choice_b = document.getElementById('formChoiceB').value.trim();
  const choice_c = document.getElementById('formChoiceC').value.trim();
  const choice_d = document.getElementById('formChoiceD').value.trim();
  const answer = document.getElementById('formAnswer').value;
  
  if (!question || !answer) {
    alert('ë¬¸ì œì™€ ì •ë‹µì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
    return;
  }
  
  const data = {
    category, number: number ? parseInt(number) : null,
    question, choice_a, choice_b, choice_c, choice_d, answer
  };
  
  const url = id ? `/api/exam_questions/${id}` : '/api/exam_questions';
  const method = id ? 'PUT' : 'POST';
  
  fetch(url, {
    method: method,
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  })
  .then(res => res.json())
  .then(result => {
    if (result.ok) {
      alert(id ? 'ë¬¸ì œê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ë¬¸ì œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
      closeQuestionFormModal();
      loadQuestionList();
    } else {
      alert('ì˜¤ë¥˜: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
    }
  })
  .catch(err => {
    console.error('ë¬¸ì œ ì €ì¥ ì‹¤íŒ¨:', err);
    alert('ë¬¸ì œ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  });
}

// ë¬¸ì œ ìˆ˜ì •
function editQuestion(id) {
  fetch(`/api/exam_questions/${id}`)
    .then(res => res.json())
    .then(q => {
      document.getElementById('questionFormTitle').textContent = 'ë¬¸ì œ ìˆ˜ì •';
      document.getElementById('questionId').value = q.id;
      document.getElementById('formCategory').value = q.category || '';
      document.getElementById('formNumber').value = q.number || '';
      document.getElementById('formQuestion').value = q.question;
      document.getElementById('formChoiceA').value = q.choice_a || '';
      document.getElementById('formChoiceB').value = q.choice_b || '';
      document.getElementById('formChoiceC').value = q.choice_c || '';
      document.getElementById('formChoiceD').value = q.choice_d || '';
      document.getElementById('formAnswer').value = q.answer;
      
      document.getElementById('questionFormModal').classList.remove('hidden');
      document.getElementById('questionFormModal').classList.add('flex');
    })
    .catch(err => {
      console.error('ë¬¸ì œ ë¡œë“œ ì‹¤íŒ¨:', err);
      alert('ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    });
}

// ë¬¸ì œ ì‚­ì œ
function deleteQuestion(id) {
  if (!confirm('ì •ë§ ì´ ë¬¸ì œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  
  fetch(`/api/exam_questions/${id}`, { method: 'DELETE' })
    .then(res => res.json())
    .then(result => {
      if (result.ok) {
        alert('ë¬¸ì œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        loadQuestionList();
      } else {
        alert('ì˜¤ë¥˜: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
      }
    })
    .catch(err => {
      console.error('ë¬¸ì œ ì‚­ì œ ì‹¤íŒ¨:', err);
      alert('ë¬¸ì œ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    });
}
</script>

{% endblock %}
