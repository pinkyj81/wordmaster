{% extends "base.html" %}
{% block content %}
<div id="testModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-xl shadow-lg w-[550px] p-6 relative">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold text-gray-800">단어 테스트</h2>
      <button onclick="closeTestModal()" class="text-gray-500 hover:text-gray-700">✕</button>
    </div>

    <!-- ✅ 진행바 -->
    <div class="mb-4">
      <div class="h-2 bg-gray-200 rounded">
        <div id="progressBar" class="h-2 bg-indigo-500 rounded" style="width:0%"></div>
      </div>
      <p class="text-sm text-gray-600 mt-1">
        <span id="currentQuestion">0</span> / <span id="totalQuestions">0</span>
      </p>
    </div>

    <!-- ✅ 문제 영역 -->
    <div class="text-center mb-6">
      <p id="questionWord" class="text-3xl font-bold text-gray-800 mb-3"></p>
      <button id="soundBtn" class="text-indigo-500 hover:text-indigo-700 mb-2 text-sm">🔊 발음 듣기</button>
      <p id="sourceText" class="text-gray-500 text-sm"></p>
    </div>

    <!-- ✅ 보기 영역 -->
    <div id="optionsContainer" class="space-y-2"></div>
  </div>
</div>

<script>
let questions = {{ words | tojson }};

// ✅ 문제 순서를 무작위로 섞기
questions = shuffle(questions);

let currentIndex = 0;
let score = 0;
let totalQuestions = questions.length;
let startTime;
let wrongWords = [];   // ✅ 틀린 단어 저장용 배열

// ✅ 테스트 시작
window.addEventListener('load', () => {
  document.getElementById("testModal").classList.remove("hidden");
  startTime = new Date();
  document.getElementById("totalQuestions").innerText = totalQuestions;
  showQuestion();
});

// ✅ 질문 표시
function showQuestion() {
  const q = questions[currentIndex];
  document.getElementById("questionWord").innerText = q.word;
  document.getElementById("sourceText").innerText = "출처: " + (q.text_title || "");
  document.getElementById("currentQuestion").innerText = currentIndex + 1;
  document.getElementById("progressBar").style.width = ((currentIndex) / totalQuestions * 100) + "%";

  const allMeanings = questions.map(x => x.meaning);
  const options = [q.meaning, ...shuffle(allMeanings.filter(m => m !== q.meaning)).slice(0, 3)];
  renderOptions(shuffle(options), q.meaning);
}

// ✅ 보기 버튼 생성
function renderOptions(options, correct) {
  const container = document.getElementById("optionsContainer");
  container.innerHTML = "";
  options.forEach((opt, idx) => {
    const btn = document.createElement("button");
    btn.className =
      "w-full border border-gray-300 rounded-lg py-2 text-gray-800 hover:bg-indigo-50 transition";
    btn.innerHTML = `<span class="font-semibold mr-2">${String.fromCharCode(65 + idx)}.</span> ${opt}`;
    btn.onclick = () => checkAnswer(opt === correct, btn, correct);
    container.appendChild(btn);
  });
}

// ✅ 정답 확인 및 오답 저장
function checkAnswer(isCorrect, btn, correct) {
  const buttons = document.querySelectorAll("#optionsContainer button");
  buttons.forEach(b => (b.disabled = true));

  const q = questions[currentIndex];
  if (isCorrect) {
    btn.classList.add("bg-green-500", "text-white");
    score++;
  } else {
    btn.classList.add("bg-red-500", "text-white");
    const correctBtn = Array.from(buttons).find(b => b.innerText.includes(correct));
    if (correctBtn) correctBtn.classList.add("bg-green-500", "text-white");

    // ✅ 오답 단어 저장
    wrongWords.push({
      word: q.word,
      meaning: q.meaning
    });
  }

  setTimeout(() => {
    currentIndex++;
    if (currentIndex < totalQuestions) {
      showQuestion();
    } else {
      finishTest();
    }
  }, 1200);
}

// ✅ 테스트 완료 처리 + DB 저장
function finishTest() {
  const endTime = new Date();
  const duration = Math.floor((endTime - startTime) / 1000); // 초 단위
  const testName = questions[0]?.text_title || "Unknown";
  const percent = Math.round((score / totalQuestions) * 100);

  // ✅ Flask 서버로 결과 전송 (오답 포함)
  fetch('/save_test_result', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      test_name: testName,
      total_questions: totalQuestions,
      correct_answers: score,
      score: percent,
      duration: duration,
      wrong_words: wrongWords   // ✅ 틀린 단어 리스트 전송
    })
  })
  .then(res => res.json())
  .then(data => {
    console.log("✅ 저장 성공:", data);
    showResult(percent, duration);
  })
  .catch(err => {
    console.error("❌ 저장 오류:", err);
    alert("결과 저장 중 오류가 발생했습니다.");
    showResult(percent, duration);
  });
}

// ✅ 결과 표시
function showResult(percent, duration) {
  const modal = document.querySelector("#testModal > div");
  modal.innerHTML = `
    <div class='text-center py-10'>
      <p class='text-3xl font-semibold text-indigo-600 mb-4'>🎉 테스트 완료!</p>
      <p class='text-lg text-gray-700 mb-3'>최종 점수: ${score} / ${totalQuestions} (${percent}%)</p>
      <p class='text-gray-600 mb-6'>소요 시간: ${duration}초</p>
      ${
        wrongWords.length > 0
          ? `<div class='mb-6 text-left w-[80%] mx-auto'>
              <p class='text-gray-800 font-semibold mb-2'>틀린 단어:</p>
              <ul class='list-disc list-inside text-gray-700'>
                ${wrongWords.map(w => `<li>${w.word} — ${w.meaning}</li>`).join('')}
              </ul>
            </div>`
          : `<p class='text-green-600 font-semibold mb-6'>모든 문제를 맞췄습니다!</p>`
      }
      <button onclick="window.location.href='/'"
              class='px-5 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-lg'>
        텍스트 목록으로 돌아가기
      </button>
    </div>
  `;
}

// ✅ 발음 버튼 (미국식)
document.getElementById("soundBtn").addEventListener("click", () => {
  const word = document.getElementById("questionWord").innerText;
  const utter = new SpeechSynthesisUtterance(word);
  utter.lang = "en-US";
  speechSynthesis.speak(utter);
});

// ✅ 닫기 버튼
function closeTestModal() {
  window.location.href = "/";
}

// ✅ 배열 섞기 함수
function shuffle(array) {
  return array.sort(() => Math.random() - 0.5);
}
</script>
{% endblock %}
