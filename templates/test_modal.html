{% extends "base.html" %}
{% block content %}
<div id="testModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-xl shadow-lg w-[550px] p-6 relative">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold text-gray-800">ë‹¨ì–´ í…ŒìŠ¤íŠ¸</h2>
      <button onclick="closeTestModal()" class="text-gray-500 hover:text-gray-700">âœ•</button>
    </div>

    <!-- âœ… ì§„í–‰ë°” -->
    <div class="mb-4">
      <div class="h-2 bg-gray-200 rounded">
        <div id="progressBar" class="h-2 bg-indigo-500 rounded" style="width:0%"></div>
      </div>
      <p class="text-sm text-gray-600 mt-1">
        <span id="currentQuestion">0</span> / <span id="totalQuestions">0</span>
      </p>
    </div>

    <!-- âœ… ë¬¸ì œ ì˜ì—­ -->
    <div class="text-center mb-6">
      <p id="questionWord" class="text-3xl font-bold text-gray-800 mb-3"></p>
      <button id="soundBtn" class="text-indigo-500 hover:text-indigo-700 mb-2 text-sm">ğŸ”Š ë°œìŒ ë“£ê¸°</button>
      <p id="sourceText" class="text-gray-500 text-sm"></p>
    </div>

    <!-- âœ… ë³´ê¸° ì˜ì—­ -->
    <div id="optionsContainer" class="space-y-2"></div>
  </div>
</div>

<script>
let questions = {{ words | tojson }};

// âœ… ë¬¸ì œ ìˆœì„œë¥¼ ë¬´ì‘ìœ„ë¡œ ì„ê¸°
questions = shuffle(questions);

let currentIndex = 0;
let score = 0;
let totalQuestions = questions.length;
let startTime;
let wrongWords = [];   // âœ… í‹€ë¦° ë‹¨ì–´ ì €ì¥ìš© ë°°ì—´

// âœ… í…ŒìŠ¤íŠ¸ ì‹œì‘
window.addEventListener('load', () => {
  document.getElementById("testModal").classList.remove("hidden");
  startTime = new Date();
  document.getElementById("totalQuestions").innerText = totalQuestions;
  showQuestion();
});

// âœ… ì§ˆë¬¸ í‘œì‹œ
function showQuestion() {
  const q = questions[currentIndex];
  document.getElementById("questionWord").innerText = q.word;
  document.getElementById("sourceText").innerText = "ì¶œì²˜: " + (q.text_title || "");
  document.getElementById("currentQuestion").innerText = currentIndex + 1;
  document.getElementById("progressBar").style.width = ((currentIndex) / totalQuestions * 100) + "%";

  const allMeanings = questions.map(x => x.meaning);
  const options = [q.meaning, ...shuffle(allMeanings.filter(m => m !== q.meaning)).slice(0, 3)];
  renderOptions(shuffle(options), q.meaning);
}

// âœ… ë³´ê¸° ë²„íŠ¼ ìƒì„±
function renderOptions(options, correct) {
  const container = document.getElementById("optionsContainer");
  container.innerHTML = "";
  options.forEach((opt, idx) => {
    const btn = document.createElement("button");
    btn.className =
      "w-full border border-gray-300 rounded-lg py-2 text-gray-800 hover:bg-indigo-50 transition";
    btn.innerHTML = `<span class="font-semibold mr-2">${String.fromCharCode(65 + idx)}.</span> ${opt}`;
    btn.onclick = () => checkAnswer(opt === correct, btn, correct);
    container.appendChild(btn);
  });
}

// âœ… ì •ë‹µ í™•ì¸ ë° ì˜¤ë‹µ ì €ì¥
function checkAnswer(isCorrect, btn, correct) {
  const buttons = document.querySelectorAll("#optionsContainer button");
  buttons.forEach(b => (b.disabled = true));

  const q = questions[currentIndex];
  if (isCorrect) {
    btn.classList.add("bg-green-500", "text-white");
    score++;
  } else {
    btn.classList.add("bg-red-500", "text-white");
    const correctBtn = Array.from(buttons).find(b => b.innerText.includes(correct));
    if (correctBtn) correctBtn.classList.add("bg-green-500", "text-white");

    // âœ… ì˜¤ë‹µ ë‹¨ì–´ ì €ì¥
    wrongWords.push({
      word: q.word,
      meaning: q.meaning
    });
  }

  setTimeout(() => {
    currentIndex++;
    if (currentIndex < totalQuestions) {
      showQuestion();
    } else {
      finishTest();
    }
  }, 1200);
}

// âœ… í…ŒìŠ¤íŠ¸ ì™„ë£Œ ì²˜ë¦¬ + DB ì €ì¥
function finishTest() {
  const endTime = new Date();
  const duration = Math.floor((endTime - startTime) / 1000); // ì´ˆ ë‹¨ìœ„
  const testName = questions[0]?.text_title || "Unknown";
  const percent = Math.round((score / totalQuestions) * 100);

  // âœ… Flask ì„œë²„ë¡œ ê²°ê³¼ ì „ì†¡ (ì˜¤ë‹µ í¬í•¨)
  fetch('/save_test_result', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      test_name: testName,
      total_questions: totalQuestions,
      correct_answers: score,
      score: percent,
      duration: duration,
      wrong_words: wrongWords   // âœ… í‹€ë¦° ë‹¨ì–´ ë¦¬ìŠ¤íŠ¸ ì „ì†¡
    })
  })
  .then(res => res.json())
  .then(data => {
    console.log("âœ… ì €ì¥ ì„±ê³µ:", data);
    showResult(percent, duration);
  })
  .catch(err => {
    console.error("âŒ ì €ì¥ ì˜¤ë¥˜:", err);
    alert("ê²°ê³¼ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    showResult(percent, duration);
  });
}

// âœ… ê²°ê³¼ í‘œì‹œ
function showResult(percent, duration) {
  const modal = document.querySelector("#testModal > div");
  modal.innerHTML = `
    <div class='text-center py-10'>
      <p class='text-3xl font-semibold text-indigo-600 mb-4'>ğŸ‰ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!</p>
      <p class='text-lg text-gray-700 mb-3'>ìµœì¢… ì ìˆ˜: ${score} / ${totalQuestions} (${percent}%)</p>
      <p class='text-gray-600 mb-6'>ì†Œìš” ì‹œê°„: ${duration}ì´ˆ</p>
      ${
        wrongWords.length > 0
          ? `<div class='mb-6 text-left w-[80%] mx-auto'>
              <p class='text-gray-800 font-semibold mb-2'>í‹€ë¦° ë‹¨ì–´:</p>
              <ul class='list-disc list-inside text-gray-700'>
                ${wrongWords.map(w => `<li>${w.word} â€” ${w.meaning}</li>`).join('')}
              </ul>
            </div>`
          : `<p class='text-green-600 font-semibold mb-6'>ëª¨ë“  ë¬¸ì œë¥¼ ë§ì·„ìŠµë‹ˆë‹¤!</p>`
      }
      <button onclick="window.location.href='/'"
              class='px-5 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-lg'>
        í…ìŠ¤íŠ¸ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
      </button>
    </div>
  `;
}

// âœ… ë°œìŒ ë²„íŠ¼ (ë¯¸êµ­ì‹)
document.getElementById("soundBtn").addEventListener("click", () => {
  const word = document.getElementById("questionWord").innerText;
  const utter = new SpeechSynthesisUtterance(word);
  utter.lang = "en-US";
  speechSynthesis.speak(utter);
});

// âœ… ë‹«ê¸° ë²„íŠ¼
function closeTestModal() {
  window.location.href = "/";
}

// âœ… ë°°ì—´ ì„ê¸° í•¨ìˆ˜
function shuffle(array) {
  return array.sort(() => Math.random() - 0.5);
}
</script>
{% endblock %}
