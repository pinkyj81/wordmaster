{% extends "base.html" %}
{% block content %}
<div class="p-8">
  <h2 class="text-2xl font-bold mb-6 text-gray-800">학습 기록 대시보드</h2>

  <!-- ✅ 테스트 횟수 요약 그래프 -->
  <div class="bg-white p-6 rounded-xl shadow mb-8">
    <h3 class="text-lg font-semibold mb-4 text-gray-700">텍스트별 테스트 횟수</h3>
    <canvas id="testCountChart" height="120"></canvas>
  </div>

  <!-- ✅ 학습 기록 테이블 -->
  <div class="bg-white p-6 rounded-xl shadow">
    <h3 class="text-lg font-semibold mb-4 text-gray-700">상세 기록</h3>

    <!-- 검색 (텍스트 제목으로) -->
    <form method="get" class="mb-4 flex items-center gap-2">
      <input list="testNames" name="q" placeholder="텍스트 제목으로 검색..." value="{{ q }}" class="border rounded px-3 py-2 w-64" />
      <datalist id="testNames">
        {% for t in test_names %}
          <option value="{{ t }}">
        {% endfor %}
      </datalist>
      <button type="submit" class="px-3 py-2 bg-indigo-600 text-white rounded">검색</button>
      {% if q %}
        <a href="/learning_log" class="px-3 py-2 bg-gray-200 rounded">초기화</a>
      {% endif %}
      <p class="text-sm text-gray-500 ml-4">{{ logs|length }}건</p>
    </form>

    {% if logs %}
      <table class="w-full border-collapse text-sm">
        <thead>
          <tr class="bg-blue-100 text-gray-800 text-left">
            <th class="p-3 border">날짜</th>
            <th class="p-3 border">테스트 이름</th>
            <th class="p-3 border text-center">문항 수</th>
            <th class="p-3 border text-center">정답 수</th>
            <th class="p-3 border text-center">점수</th>
            <th class="p-3 border text-center">소요 시간</th>
            <th class="p-3 border text-center">틀린 단어</th>
          </tr>
        </thead>
        <tbody>
          {% for log in logs %}
          <tr class="hover:bg-gray-50 text-gray-700">
            <td class="p-3 border">{{ log.completed_at.strftime('%Y-%m-%d %H:%M') }}</td>
            <td class="p-3 border">{{ log.test_name }}</td>
            <td class="p-3 border text-center">{{ log.total_questions }}</td>
            <td class="p-3 border text-center">{{ log.correct_answers }}</td>

            <!-- ✅ 점수 정수 + % 표시 -->
            <td class="p-3 border text-blue-600 font-semibold text-center">
              {{ "%.0f"|format(log.score) }}%
            </td>

            <td class="p-3 border text-center">{{ log.duration }}초</td>

            <!-- ✅ 틀린 단어 보기 버튼 -->
            <td class="p-3 border text-center">
              <button
                onclick="showWrongWords({{ log.test_words | safe }})"
                class="px-3 py-1 bg-indigo-500 text-white rounded hover:bg-indigo-600 text-xs">
                보기
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="text-gray-500">아직 테스트 기록이 없습니다.</p>
    {% endif %}
  </div>
</div>

<!-- ✅ 틀린 단어 모달 -->
<div id="wrongWordModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
  <div class="bg-white rounded-xl p-6 w-[400px] shadow-lg max-h-[70vh] overflow-y-auto">
    <h3 class="text-lg font-semibold text-gray-800 mb-3">틀린 단어 목록</h3>
    <ul id="wrongWordList" class="space-y-1 text-gray-700 mb-4"></ul>
    <button onclick="closeWrongWordModal()" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">닫기</button>
  </div>
</div>

<!-- ✅ Chart.js 그래프 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const summaryData = {{ summary | tojson }};
const ctx = document.getElementById('testCountChart').getContext('2d');

const labels = summaryData.map(s => s.test_name);
const counts = summaryData.map(s => s.test_count);

new Chart(ctx, {
  type: 'bar',
  data: {
    labels: labels,
    datasets: [{
      label: '테스트 횟수',
      data: counts,
      backgroundColor: 'rgba(59, 130, 246, 0.6)',
      borderColor: 'rgba(59, 130, 246, 1)',
      borderWidth: 1,
      borderRadius: 5,
    }]
  },
  options: {
    responsive: true,
    scales: {
      y: {
        beginAtZero: true,
        ticks: { stepSize: 1 }
      }
    },
    plugins: {
      legend: { display: false },
      tooltip: { backgroundColor: '#2563EB', titleColor: '#fff', bodyColor: '#fff' }
    }
  }
});


// ✅ 틀린 단어 모달 표시 함수
function showWrongWords(data) {
  const modal = document.getElementById("wrongWordModal");
  const list = document.getElementById("wrongWordList");
  list.innerHTML = "";

  if (!data || data.length === 0) {
    list.innerHTML = "<li class='text-gray-500'>모든 문제를 맞췄습니다!</li>";
  } else {
    data.forEach(w => {
      const li = document.createElement("li");
      li.textContent = `${w.word} — ${w.meaning}`;
      list.appendChild(li);
    });
  }

  modal.classList.remove("hidden");
  modal.classList.add("flex");
}

// ✅ 모달 닫기
function closeWrongWordModal() {
  const modal = document.getElementById("wrongWordModal");
  modal.classList.add("hidden");
}
</script>
{% endblock %}
