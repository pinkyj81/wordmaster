<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Word Master</title>

  <!-- âœ… TailwindCSS & Font -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Noto Sans KR', sans-serif; }
    .menu-dropdown {
      position: relative;
    }
    .menu-dropdown summary {
      list-style: none;
      cursor: pointer;
      padding: 0.375rem 0.6rem;
      border-radius: 0.5rem;
      user-select: none;
      transition: background-color 0.2s;
    }
    .menu-dropdown summary::-webkit-details-marker {
      display: none;
    }
    .menu-dropdown[open] summary,
    .menu-dropdown summary:hover {
      background: rgba(255, 255, 255, 0.14);
    }
    .menu-panel {
      position: absolute;
      top: calc(100% + 0.45rem);
      right: 0;
      min-width: 12rem;
      background: #fff;
      color: #1f2937;
      border: 1px solid #e5e7eb;
      border-radius: 0.75rem;
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.18);
      padding: 0.45rem;
      z-index: 70;
    }
    .menu-item {
      display: block;
      width: 100%;
      text-align: left;
      font-size: 0.875rem;
      color: #1f2937;
      text-decoration: none;
      padding: 0.52rem 0.62rem;
      border-radius: 0.5rem;
      border: 0;
      background: transparent;
      cursor: pointer;
    }
    .menu-item:hover {
      background: #f3f4f6;
    }
    .menu-divider {
      margin: 0.35rem 0;
      border-top: 1px solid #e5e7eb;
    }
    /* ë‹¨ì–´ ì°¾ê¸° ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    #wordSearchResults .word-card {
      background: white;
      padding: 16px;
      margin-bottom: 12px;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
    }
    #wordSearchResults .word-title {
      font-size: 18px;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 8px;
    }
    #wordSearchResults .word-meaning {
      font-size: 14px;
      color: #555;
      margin-bottom: 6px;
    }
    #wordSearchResults .word-example {
      font-size: 13px;
      color: #666;
      font-style: italic;
      padding: 8px;
      background: #f8f9fa;
      border-left: 2px solid #007bff;
      margin-top: 8px;
    }
    /* ë‹¨ì–´ ê´€ë¦¬ ëª¨ë‹¬ - editable ì…€ ìŠ¤íƒ€ì¼ */
    .mgmt-word-cell {
      padding: 6px;
      border-radius: 4px;
      min-height: 20px;
      outline: none;
      transition: all 0.2s;
    }
    .mgmt-word-cell:focus {
      background-color: #dbeafe;
      outline: 2px solid #3b82f6;
    }
    .mgmt-word-cell:empty:before {
      content: attr(data-placeholder);
      color: #d1d5db;
    }
  </style>
</head>

<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col">

  <!-- ğŸ”¹ ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
  <nav class="bg-gradient-to-r from-purple-600 via-purple-500 to-indigo-600 text-white px-6 py-3 flex items-center justify-between shadow-md">
    <div class="flex items-center space-x-3">
      <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo" class="w-8 h-8 rounded-full">
      <a href="/" class="font-bold text-lg hover:text-purple-200">Word Master</a>
    </div>

    <div class="flex items-center gap-2 text-sm font-medium">
      <a href="/" class="px-2 py-1.5 rounded-lg hover:bg-white/15">í™ˆ</a>

      <details class="menu-dropdown">
        <summary>ë³¸ë¬¸/ë‹¨ì–´</summary>
        <div class="menu-panel">
          <a href="/" class="menu-item">ë³¸ë¬¸ ëª©ë¡</a>
          <button type="button" onclick="openWordSearchModal()" class="menu-item">ë‹¨ì–´ ì°¾ê¸°</button>
          <button type="button" onclick="openWordManagementModal()" class="menu-item">ë‹¨ì–´ ê´€ë¦¬</button>
          <button type="button" onclick="openUploadModal()" class="menu-item">ë³¸ë¬¸ ì—…ë¡œë“œ</button>
        </div>
      </details>

      <details class="menu-dropdown">
        <summary>TEST</summary>
        <div class="menu-panel">
          <a href="/spelling_test" class="menu-item">ìŠ¤í ë§ í…ŒìŠ¤íŠ¸</a>
          <a href="/exam_questions" class="menu-item">í…ìŠ¤ë¬¸ì œ</a>
          <a href="/chinese" class="menu-item">í•œì í•™ìŠµ</a>
          <a href="/learning_log" class="menu-item">í•™ìŠµ ê¸°ë¡</a>
        </div>
      </details>

      <details class="menu-dropdown">
        <summary>ì‚¬ìš©ì ê´€ë¦¬</summary>
        <div class="menu-panel">
          <button type="button" onclick="openUserManager()" class="menu-item">ì‚¬ìš©ì ê´€ë¦¬</button>
          <div class="menu-divider"></div>
          <a href="/logout" class="menu-item">ë¡œê·¸ì•„ì›ƒ</a>
        </div>
      </details>

      <a href="https://study-plan-6z8q.onrender.com/" target="_blank" class="px-2 py-1.5 rounded-lg hover:bg-white/15">ìì£¼ë…ë¦½</a>
    </div>
  </nav>

  <!-- ğŸ”¹ ë³¸ë¬¸ -->
  <main class="flex-1 p-6">
    {% block content %}{% endblock %}
  </main>

  <!-- ğŸ”¹ í‘¸í„° -->
  <footer class="text-center text-gray-500 text-sm py-4 border-t">
    Â© 2025 Word Master | Designed by Yujin
  </footer>

  <!-- ğŸ”¹ ë³¸ë¬¸ & ë‹¨ì–´ ì—…ë¡œë“œ ëª¨ë‹¬ -->
  <div id="uploadModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-xl w-[800px] p-8 relative">
      <!-- í—¤ë” -->
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800">ë³¸ë¬¸ ë° ë‹¨ì–´ ì—…ë¡œë“œ</h2>
        <button onclick="closeUploadModal()" class="text-gray-400 hover:text-gray-600 text-2xl absolute top-4 right-6">&times;</button>
      </div>
      <p class="text-gray-500 mb-6">ë³¸ë¬¸ì„ ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ ë‹¨ì–´ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”</p>

      <!-- âœ… íƒ­ ë©”ë‰´ -->
      <div class="border-b mb-6">
        <nav class="flex space-x-8">
          <button id="tabText" onclick="switchTab('text')" class="pb-2 border-b-2 border-blue-600 text-blue-600 font-semibold">ë³¸ë¬¸ ì—…ë¡œë“œ</button>
          <button id="tabWord" onclick="switchTab('word')" class="pb-2 text-gray-500 hover:text-blue-600">ë‹¨ì–´ ì—…ë¡œë“œ</button>
        </nav>
      </div>

      <!-- âœ… ë³¸ë¬¸ ì—…ë¡œë“œ íƒ­ -->
      <div id="textUploadTab">
        <label class="block text-sm font-semibold text-gray-700 mb-1">ì œëª©</label>
        <input id="uploadTitle" class="w-full border rounded-lg p-2 mb-4" placeholder="ë³¸ë¬¸ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">

        <label class="block text-sm font-semibold text-gray-700 mb-1">ì¶œì²˜ (ì„ íƒì‚¬í•­)</label>
        <input id="uploadSource" class="w-full border rounded-lg p-2 mb-4" placeholder="ì˜ˆ: BBC News, êµê³¼ì„œ ë“±">

        <label class="block text-sm font-semibold text-gray-700 mb-1">ë³¸ë¬¸ ë‚´ìš© *</label>
        <textarea id="uploadContent" rows="8" class="w-full border rounded-lg p-3 mb-6" placeholder="ì˜ì–´ ë³¸ë¬¸ì„ ì…ë ¥í•˜ê±°ë‚˜ ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”..."></textarea>

        <div class="flex justify-end space-x-3">
          <button onclick="closeUploadModal()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">ì·¨ì†Œ</button>
          <button onclick="submitTextUpload()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">ì €ì¥</button>
        </div>
      </div>

      <!-- âœ… ë‹¨ì–´ ì—…ë¡œë“œ íƒ­ -->
<div id="wordUploadTab" class="hidden">
  <label class="block text-sm font-semibold text-gray-700 mb-1">ë³¸ë¬¸ ì„ íƒ</label>
  <select id="wordTextSelect" class="w-full border rounded-lg p-2 mb-4">
    <option value="">ë³¸ë¬¸ì„ ì„ íƒí•˜ì„¸ìš”</option>
  </select>

  <label class="block text-sm font-semibold text-gray-700 mb-1">ë‹¨ì–´ ëª©ë¡ (í•œ ì¤„ë‹¹ í•˜ë‚˜ì”©)</label>
  <textarea id="bulkWordInput" rows="8" class="w-full border rounded-lg p-3 mb-6"
    placeholder="ì˜ˆì‹œ:&#10;glyph	ìƒí˜•ë¬¸ì&#10;haphazard	ê³„íšì„±ì´ ì—†ëŠ”&#10;hereditary	ìœ ì „ì˜"></textarea>

  <div class="flex justify-end space-x-2">
    <button onclick="closeUploadModal()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">ì·¨ì†Œ</button>
    <button onclick="submitBulkWords()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">ì €ì¥</button>
  </div>
</div>

      </div>
    </div>
  </div>

  <!-- ğŸ”¹ ìŠ¤í¬ë¦½íŠ¸ -->
  <script>
    document.addEventListener('click', (event) => {
      const dropdowns = document.querySelectorAll('.menu-dropdown');
      dropdowns.forEach((dropdown) => {
        if (!dropdown.contains(event.target)) {
          dropdown.removeAttribute('open');
        }
      });
    });

    // âœ… íƒ­ ì „í™˜
    function switchTab(tab) {
      const textTab = document.getElementById('textUploadTab');
      const wordTab = document.getElementById('wordUploadTab');
      const btnText = document.getElementById('tabText');
      const btnWord = document.getElementById('tabWord');

      if (tab === 'text') {
        textTab.classList.remove('hidden');
        wordTab.classList.add('hidden');
        btnText.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
        btnWord.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
      } else {
        textTab.classList.add('hidden');
        wordTab.classList.remove('hidden');
        btnWord.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
        btnText.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
        // ë‹¨ì–´ íƒ­ìœ¼ë¡œ ì „í™˜ì‹œ ë³¸ë¬¸ëª©ë¡ ë¡œë“œ
        loadTextOptionsForBaseModal();
      }
    }

    // âœ… ëª¨ë‹¬ ì—´ê¸° / ë‹«ê¸°
    function openUploadModal() {
      const modal = document.getElementById('uploadModal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }
    function closeUploadModal() {
      const modal = document.getElementById('uploadModal');
      modal.classList.add('hidden');
    }

    // âœ… ë³¸ë¬¸ ëª©ë¡ ë¡œë“œ (base.htmlìš©)
    function loadTextOptionsForBaseModal() {
      const select = document.getElementById('wordTextSelect');
      select.innerHTML = '<option value="">ë³¸ë¬¸ì„ ì„ íƒí•˜ì„¸ìš”</option>';
      
      fetch('/get_text_titles')
        .then(res => res.json())
        .then(texts => {
          if (texts.length === 0) {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'ë“±ë¡ëœ ë³¸ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤';
            option.disabled = true;
            select.appendChild(option);
            return;
          }
          
          texts.forEach(text => {
            const option = document.createElement('option');
            option.value = text.id;
            // ì¶œì²˜ ì •ë³´ë„ í•¨ê»˜ í‘œì‹œ
            option.textContent = text.source ? `[${text.source}] ${text.title}` : text.title;
            select.appendChild(option);
          });
        })
        .catch(err => {
          console.error('ë³¸ë¬¸ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', err);
        });
    }

    // âœ… ë³¸ë¬¸ ì—…ë¡œë“œ
    function submitTextUpload() {
      const title = document.getElementById('uploadTitle').value.trim();
      const source = document.getElementById('uploadSource').value.trim();
      const content = document.getElementById('uploadContent').value.trim();
      if (!title || !content) return alert('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');

      fetch('/upload_text', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, source, content })
      })
      .then(res => res.json())
      .then(() => {
        alert('âœ… ë³¸ë¬¸ ì—…ë¡œë“œ ì™„ë£Œ');
        closeUploadModal();
        location.reload();
      })
      .catch(() => alert('âŒ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ'));
    }

    // âœ… ë‹¨ì–´ ì¼ê´„ ì—…ë¡œë“œ
    function submitBulkWords() {
      const textId = document.getElementById('wordTextSelect').value;
      const rawList = document.getElementById('bulkWordInput').value.trim();

      if (!textId) return alert('ë³¸ë¬¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
      if (!rawList) return alert('ë‹¨ì–´ ëª©ë¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');

      // ë‹¨ì–´ ëª©ë¡ íŒŒì‹± (íƒ­ ë˜ëŠ” ê³µë°±ìœ¼ë¡œ êµ¬ë¶„)
      const words = rawList.split('\n').map(line => {
        const parts = line.trim().split(/\t+/);
        if (parts.length >= 2) {
          return { word: parts[0].trim(), meaning: parts.slice(1).join(' ').trim() };
        }
        // íƒ­ì´ ì—†ìœ¼ë©´ ê³µë°±ìœ¼ë¡œ ì‹œë„
        const [word, ...rest] = line.trim().split(/\s+/);
        return word && rest.length ? { word, meaning: rest.join(' ') } : null;
      }).filter(Boolean);

      if (words.length === 0) return alert('ì˜¬ë°”ë¥¸ í˜•ì‹ìœ¼ë¡œ ë‹¨ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');

      fetch('/upload_words', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text_id: textId, words })
      })
      .then(res => res.json())
      .then(() => {
        alert('âœ… ë‹¨ì–´ ì—…ë¡œë“œ ì™„ë£Œ');
        closeUploadModal();
        location.reload();
      })
      .catch(() => alert('âŒ ë‹¨ì–´ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ'));
    }
  </script>
  <!-- âœ… ë‹¨ì–´ ì°¾ê¸° ëª¨ë‹¬ -->
  <div id="wordSearchModal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 backdrop-blur-sm">
    <div class="bg-white rounded-2xl shadow-2xl w-[90%] max-w-4xl p-8 max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center border-b pb-3 mb-4">
        <h3 class="text-2xl font-bold text-gray-800">ğŸ” ë‹¨ì–´ ì°¾ê¸°</h3>
        <button onclick="closeWordSearchModal()" class="text-gray-500 hover:text-gray-700 text-3xl leading-none">&times;</button>
      </div>

      <div class="bg-gray-50 rounded-lg p-4 mb-6">
        <form id="wordSearchForm" onsubmit="handleWordSearch(event)" class="flex gap-2 items-end">
          <div class="flex-1">
            <label class="block text-sm font-medium text-gray-700 mb-1">ê²€ìƒ‰ì–´</label>
            <input type="text" id="wordSearchInput" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." class="w-full border rounded px-3 py-2">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">ê²€ìƒ‰ ë°©ì‹</label>
            <select id="wordSearchType" class="border rounded px-3 py-2">
              <option value="word">ë‹¨ì–´</option>
              <option value="meaning">ëœ»</option>
              <option value="all">ì „ì²´</option>
            </select>
          </div>
          <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">ê²€ìƒ‰</button>
        </form>
      </div>

      <div id="wordSearchResults" class="space-y-3">
        <p class="text-gray-500 text-center py-8">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì—¬ ë‹¨ì–´ë¥¼ ì°¾ìœ¼ì„¸ìš”</p>
      </div>
    </div>
  </div>

  <!-- âœ… ë‹¨ì–´ ê´€ë¦¬ ëª¨ë‹¬ -->
  <div id="wordManagementModal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 backdrop-blur-sm">
    <div class="bg-white rounded-2xl shadow-2xl w-[95%] max-w-6xl p-8 max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center border-b pb-3 mb-4">
        <h3 class="text-2xl font-bold text-gray-800">ë‹¨ì–´ ê´€ë¦¬</h3>
        <button onclick="closeWordManagementModal()" class="text-gray-500 hover:text-gray-700 text-3xl leading-none">&times;</button>
      </div>

      <!-- ì¶œì²˜ ì„ íƒ -->
      <div class="mb-4">
        <label class="block mb-2 text-gray-700 font-medium">ì¶œì²˜ ì„ íƒ</label>
        <select id="mgmtSourceSelector" class="border rounded px-3 py-2 w-full max-w-md" onchange="mgmtLoadTitlesBySource()">
          <option value="">ì¶œì²˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
        </select>
      </div>

      <!-- ë³¸ë¬¸ ì œëª© ì„ íƒ -->
      <div class="mb-6">
        <label class="block mb-2 text-gray-700 font-medium">ë³¸ë¬¸ ì„ íƒ</label>
        <select id="mgmtTextSelector" class="border rounded px-3 py-2 w-full max-w-md" onchange="mgmtLoadWordsByText()">
          <option value="">ì œëª©ì„ ì„ íƒí•˜ì„¸ìš”</option>
        </select>
      </div>

      <!-- ë‹¨ì–´ ëª©ë¡ í…Œì´ë¸” -->
      <div id="mgmtWordListContainer" class="hidden">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold text-gray-700">ë‹¨ì–´ ëª©ë¡</h3>
          <div class="flex gap-2">
            <span id="mgmtWordCount" class="text-sm text-gray-600"></span>
            <button onclick="mgmtSaveChanges()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-sm">ì €ì¥</button>
          </div>
        </div>

        <div class="overflow-x-auto max-h-96 border rounded">
          <table id="mgmtWordTable" class="w-full text-sm border-collapse">
            <thead>
              <tr class="bg-gradient-to-r from-purple-100 to-indigo-100 sticky top-0">
                <th class="border px-3 py-2 text-left font-semibold text-gray-700 w-24">ë‹¨ì–´</th>
                <th class="border px-3 py-2 text-left font-semibold text-gray-700 w-40">ëœ»</th>
                <th class="border px-3 py-2 text-left font-semibold text-gray-700 flex-1">ì˜ˆë¬¸</th>
                <th class="border px-3 py-2 text-center font-semibold text-gray-700 w-20">ì‚­ì œ</th>
              </tr>
            </thead>
            <tbody id="mgmtWordListTable" class="text-xs">
              <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤ -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- âœ… ì‚¬ìš©ì ê´€ë¦¬ ëª¨ë‹¬ -->
  <div id="userManagerModal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 backdrop-blur-sm">
    <div class="bg-white rounded-2xl shadow-2xl w-[90%] max-w-4xl p-8 max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center border-b pb-3 mb-4">
        <h3 class="text-2xl font-bold text-gray-800">ì‚¬ìš©ì ê´€ë¦¬</h3>
        <button onclick="closeUserManager()" class="text-gray-500 hover:text-gray-700 text-3xl leading-none">&times;</button>
      </div>

      <!-- ì¶”ê°€ í¼ -->
      <div class="bg-gray-50 rounded-lg p-4 mb-6">
        <h4 class="font-semibold text-lg mb-3 text-gray-700">ìƒˆ ì‚¬ìš©ì-ì¶œì²˜ ì¶”ê°€</h4>
        <div class="flex gap-3 items-end">
          <div class="flex-1">
            <label class="block text-sm font-medium text-gray-700 mb-1">ì‚¬ìš©ìëª…</label>
            <input type="text" id="newUserName" class="w-full border rounded px-3 py-2" placeholder="ì˜ˆ: ë°•ì˜ì§„">
          </div>
          <div class="flex-1">
            <label class="block text-sm font-medium text-gray-700 mb-1">ì¶œì²˜</label>
            <select id="newUserSource" class="w-full border rounded px-3 py-2">
              <option value="">ì¶œì²˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
              <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤ -->
            </select>
          </div>
          <button onclick="addUser()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition">
            ì¶”ê°€
          </button>
        </div>
      </div>

      <!-- ì‚¬ìš©ì ëª©ë¡ í…Œì´ë¸” -->
      <div class="overflow-x-auto">
        <table class="w-full text-sm border-collapse">
          <thead>
            <tr class="bg-gradient-to-r from-purple-100 to-indigo-100">
              <th class="border px-4 py-3 text-left font-semibold text-gray-700">ID</th>
              <th class="border px-4 py-3 text-left font-semibold text-gray-700">ì‚¬ìš©ìëª…</th>
              <th class="border px-4 py-3 text-left font-semibold text-gray-700">ì¶œì²˜</th>
              <th class="border px-4 py-3 text-center font-semibold text-gray-700">ì‘ì—…</th>
            </tr>
          </thead>
          <tbody id="userListTable">
            <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤ -->
          </tbody>
        </table>
      </div>

      <div class="text-right mt-6">
        <button onclick="closeUserManager()" class="px-6 py-2 bg-gray-200 rounded hover:bg-gray-300 transition">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- âœ… Bootstrap JS (ëª¨ë‹¬ ë™ì‘ìš©) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
// âœ… ë‹¨ì–´ ì°¾ê¸° ëª¨ë‹¬ í•¨ìˆ˜ë“¤
function openWordSearchModal() {
  document.getElementById('wordSearchModal').classList.remove('hidden');
  document.getElementById('wordSearchInput').focus();
}

function closeWordSearchModal() {
  document.getElementById('wordSearchModal').classList.add('hidden');
}

function handleWordSearch(event) {
  event.preventDefault();
  const query = document.getElementById('wordSearchInput').value.trim();
  const type = document.getElementById('wordSearchType').value;
  
  if (!query) {
    alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
    return;
  }

  // ë‹¨ì–´ ê²€ìƒ‰ API í˜¸ì¶œ
  fetch(`/api/search_words?q=${encodeURIComponent(query)}&type=${type}`)
    .then(res => res.json())
    .then(words => {
      const resultsDiv = document.getElementById('wordSearchResults');
      
      if (!words || words.length === 0) {
        resultsDiv.innerHTML = '<p class="text-gray-500 text-center py-8">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
        return;
      }

      let html = `<p class="text-gray-600 mb-4">ê²€ìƒ‰ ê²°ê³¼: <strong>${words.length}ê°œ</strong></p>`;
      words.forEach(word => {
        html += `
          <div class="bg-white p-4 rounded border border-gray-200 mb-3 hover:shadow-md transition">
            <div class="font-bold text-lg text-gray-800 mb-1">${word.word || ''}</div>
            <div class="text-gray-700 text-sm mb-2">ëœ»: ${word.meaning || ''}</div>
            ${word.example ? `<div class="text-xs text-gray-600 italic bg-gray-50 p-2 rounded mb-2">${word.example}</div>` : ''}
            ${word.text_title ? `<div class="text-xs text-gray-500">ì¶œì²˜: ${word.text_title}</div>` : ''}
            ${word.is_learned ? `<div class="text-xs text-green-600 font-semibold mt-1">âœ“ ì•”ê¸°ì™„ë£Œ</div>` : ''}
          </div>
        `;
      });
      resultsDiv.innerHTML = html;
    })
    .catch(err => {
      console.error('ê²€ìƒ‰ ì‹¤íŒ¨:', err);
      document.getElementById('wordSearchResults').innerHTML = '<p class="text-red-500 text-center">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ</p>';
    });
}

// âœ… ë‹¨ì–´ ê´€ë¦¬ ëª¨ë‹¬ í•¨ìˆ˜ë“¤
function openWordManagementModal() {
  document.getElementById('wordManagementModal').classList.remove('hidden');
  mgmtLoadSourceOptions();
}

function closeWordManagementModal() {
  document.getElementById('wordManagementModal').classList.add('hidden');
}

function mgmtLoadSourceOptions() {
  fetch('/get_sources')
    .then(res => res.json())
    .then(sources => {
      const select = document.getElementById('mgmtSourceSelector');
      select.innerHTML = '<option value="">ì¶œì²˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
      sources.forEach(src => {
        const option = document.createElement('option');
        option.value = src.source;
        option.textContent = src.source;
        select.appendChild(option);
      });
    })
    .catch(err => console.error('ì¶œì²˜ ë¡œë“œ ì‹¤íŒ¨:', err));
}

function mgmtLoadTitlesBySource() {
  const source = document.getElementById('mgmtSourceSelector').value;
  const select = document.getElementById('mgmtTextSelector');
  
  if (!source) {
    select.innerHTML = '<option value="">ì œëª©ì„ ì„ íƒí•˜ì„¸ìš”</option>';
    return;
  }

  fetch('/get_text_titles')
    .then(res => res.json())
    .then(texts => {
      select.innerHTML = '<option value="">ì œëª©ì„ ì„ íƒí•˜ì„¸ìš”</option>';
      texts
        .filter(t => t.source === source)
        .forEach(text => {
          const option = document.createElement('option');
          option.value = text.id;
          option.textContent = text.title;
          select.appendChild(option);
        });
    })
    .catch(err => console.error('ì œëª© ë¡œë“œ ì‹¤íŒ¨:', err));
}

function mgmtLoadWordsByText() {
  const textId = document.getElementById('mgmtTextSelector').value;
  
  if (!textId) {
    document.getElementById('mgmtWordListContainer').classList.add('hidden');
    return;
  }

  fetch(`/get_words_by_text/${textId}`)
    .then(res => res.json())
    .then(words => {
      const tbody = document.getElementById('mgmtWordListTable');
      tbody.innerHTML = '';
      document.getElementById('mgmtWordCount').textContent = `${words.length}ê°œ`;

      if (words.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="p-3 text-center text-gray-500">ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
        document.getElementById('mgmtWordListContainer').classList.remove('hidden');
        return;
      }

      words.forEach((word, idx) => {
        const tr = document.createElement('tr');
        tr.className = 'border-b hover:bg-gray-50 cursor-text';
        tr.innerHTML = `
          <td class="border px-3 py-2">
            <div class="mgmt-word-cell" data-word-id="${word.id}" data-field="word" contenteditable="true" onblur="mgmtMarkDirty(this)">${word.word || ''}</div>
          </td>
          <td class="border px-3 py-2">
            <div class="mgmt-word-cell" data-word-id="${word.id}" data-field="meaning" contenteditable="true" onblur="mgmtMarkDirty(this)">${word.meaning || ''}</div>
          </td>
          <td class="border px-3 py-2 max-w-xs">
            <div class="mgmt-word-cell text-xs whitespace-pre-wrap" data-word-id="${word.id}" data-field="example" contenteditable="true" onblur="mgmtMarkDirty(this)">${word.example ? word.example.substring(0, 100) : ''}</div>
          </td>
          <td class="border px-3 py-2 text-center">
            <button onclick="mgmtDeleteWord('${word.id}')" class="text-red-600 hover:text-red-800 text-sm font-semibold">ğŸ—‘ï¸</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      document.getElementById('mgmtWordListContainer').classList.remove('hidden');
    })
    .catch(err => {
      console.error('ë‹¨ì–´ ë¡œë“œ ì‹¤íŒ¨:', err);
      alert('ë‹¨ì–´ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
    });
}

// ë‹¨ì–´ ë³€ê²½ í‘œì‹œ
function mgmtMarkDirty(cell) {
  cell.style.backgroundColor = '#fffbeb';
  const tr = cell.closest('tr');
  if (!tr.dataset.dirty) {
    tr.dataset.dirty = 'true';
  }
}

// ë³€ê²½ì‚¬í•­ ì €ì¥
function mgmtSaveChanges() {
  const tbody = document.getElementById('mgmtWordListTable');
  const dirtyRows = tbody.querySelectorAll('tr[data-dirty="true"]');
  
  if (dirtyRows.length === 0) {
    alert('ë³€ê²½ëœ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤');
    return;
  }

  const updates = [];
  dirtyRows.forEach(row => {
    const wordCell = row.querySelector('[data-field="word"]');
    const meaningCell = row.querySelector('[data-field="meaning"]');
    const exampleCell = row.querySelector('[data-field="example"]');
    
    if (wordCell && wordCell.dataset.wordId) {
      updates.push({
        id: wordCell.dataset.wordId,
        word: wordCell.textContent.trim(),
        meaning: meaningCell.textContent.trim(),
        example: exampleCell.textContent.trim()
      });
    }
  });

  if (updates.length === 0) {
    alert('ì €ì¥í•  ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤');
    return;
  }

  Promise.all(updates.map(update => 
    fetch('/update_word', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(update)
    })
  ))
  .then(() => {
    alert(`${updates.length}ê°œ ë‹¨ì–´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤`);
    // ì €ì¥ í›„ ë°°ê²½ìƒ‰ ì´ˆê¸°í™”
    dirtyRows.forEach(row => {
      row.dataset.dirty = '';
      row.querySelectorAll('.mgmt-word-cell').forEach(cell => {
        cell.style.backgroundColor = '';
      });
    });
  })
  .catch(err => {
    console.error('ì €ì¥ ì‹¤íŒ¨:', err);
    alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
  });
}

// ë‹¨ì–´ ì‚­ì œ
function mgmtDeleteWord(wordId) {
  if (!confirm('ì´ ë‹¨ì–´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  
  fetch(`/delete_word/${wordId}`, { method: 'DELETE' })
    .then(res => res.json())
    .then(data => {
      if (data.success || data.ok) {
        alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
        const textId = document.getElementById('mgmtTextSelector').value;
        mgmtLoadWordsByText(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
      } else {
        alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
      }
    })
    .catch(err => {
      console.error('ì‚­ì œ ì‹¤íŒ¨:', err);
      alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    });
}

// âœ… ì‚¬ìš©ì ê´€ë¦¬ ëª¨ë‹¬ ì—´ê¸°
function openUserManager() {
  document.getElementById('userManagerModal').classList.remove('hidden');
  loadSourceOptions();
  loadUserList();
}

// âœ… ì‚¬ìš©ì ê´€ë¦¬ ëª¨ë‹¬ ë‹«ê¸°
function closeUserManager() {
  document.getElementById('userManagerModal').classList.add('hidden');
}

// âœ… ì¶œì²˜ ëª©ë¡ ë¡œë“œ
function loadSourceOptions() {
  fetch('/get_sources')
    .then(res => res.json())
    .then(sources => {
      const select = document.getElementById('newUserSource');
      select.innerHTML = '<option value="">ì¶œì²˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
      sources.forEach(src => {
        const option = document.createElement('option');
        option.value = src.source;
        option.textContent = src.source;
        select.appendChild(option);
      });
      // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥í•´ì„œ í…Œì´ë¸”ì—ì„œë„ ì‚¬ìš©
      window.availableSources = sources.map(s => s.source);
    })
    .catch(err => {
      console.error('ì¶œì²˜ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', err);
    });
}

// âœ… ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ
function loadUserList() {
  fetch('/api/users')
    .then(res => res.json())
    .then(users => {
      const tbody = document.getElementById('userListTable');
      tbody.innerHTML = '';
      
      if (users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="border px-4 py-3 text-center text-gray-500">ë“±ë¡ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }

      users.forEach(user => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50';
        
        tr.innerHTML = `
          <td class="border px-4 py-2">${user.id}</td>
          <td class="border px-4 py-2">
            <input type="text" id="userName-${user.id}" value="${user.user_name}" 
                   class="w-full px-2 py-1 border rounded focus:border-blue-500">
          </td>
          <td class="border px-4 py-2">
            <span class="px-3 py-1 bg-blue-50 text-blue-700 rounded-full text-sm font-medium">${user.source}</span>
            <input type="hidden" id="userSource-${user.id}" value="${user.source}">
          </td>
          <td class="border px-4 py-2 text-center space-x-2">
            <button onclick="updateUser(${user.id})" 
                    class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 text-xs">
              ìˆ˜ì •
            </button>
            <button onclick="deleteUser(${user.id})" 
                    class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 text-xs">
              ì‚­ì œ
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    })
    .catch(err => {
      console.error('ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', err);
      alert('ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    });
}

// âœ… ì‚¬ìš©ì ì¶”ê°€
function addUser() {
  const userName = document.getElementById('newUserName').value.trim();
  const source = document.getElementById('newUserSource').value.trim();

  if (!userName || !source) {
    alert('ì‚¬ìš©ìëª…ê³¼ ì¶œì²˜ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.');
    return;
  }

  fetch('/api/users', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ user_name: userName, source: source })
  })
    .then(res => res.json())
    .then(data => {
      if (data.ok) {
        alert('ì‚¬ìš©ìê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
        document.getElementById('newUserName').value = '';
        document.getElementById('newUserSource').value = '';
        loadUserList();
      } else {
        alert(data.error || 'ì¶”ê°€ ì‹¤íŒ¨');
      }
    })
    .catch(err => {
      console.error('ì‚¬ìš©ì ì¶”ê°€ ì‹¤íŒ¨:', err);
      alert('ì‚¬ìš©ì ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    });
}

// âœ… ì‚¬ìš©ì ìˆ˜ì •
function updateUser(userId) {
  const userName = document.getElementById(`userName-${userId}`).value.trim();
  const source = document.getElementById(`userSource-${userId}`).value.trim();

  if (!userName || !source) {
    alert('ì‚¬ìš©ìëª…ê³¼ ì¶œì²˜ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.');
    return;
  }

  fetch(`/api/users/${userId}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ user_name: userName, source: source })
  })
    .then(res => res.json())
    .then(data => {
      if (data.ok) {
        alert('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
        loadUserList();
      } else {
        alert(data.error || 'ìˆ˜ì • ì‹¤íŒ¨');
      }
    })
    .catch(err => {
      console.error('ì‚¬ìš©ì ìˆ˜ì • ì‹¤íŒ¨:', err);
      alert('ì‚¬ìš©ì ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    });
}

// âœ… ì‚¬ìš©ì ì‚­ì œ
function deleteUser(userId) {
  if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

  fetch(`/api/users/${userId}`, { method: 'DELETE' })
    .then(res => res.json())
    .then(data => {
      if (data.ok) {
        alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        loadUserList();
      } else {
        alert(data.error || 'ì‚­ì œ ì‹¤íŒ¨');
      }
    })
    .catch(err => {
      console.error('ì‚¬ìš©ì ì‚­ì œ ì‹¤íŒ¨:', err);
      alert('ì‚¬ìš©ì ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    });
}
</script>

</body>
</html>
