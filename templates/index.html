{% extends "base.html" %}
{% block content %}

<h2 class="text-2xl font-semibold mb-6 text-gray-800">텍스트 기록</h2>

<!-- 상단 필터/검색 + 업로드 버튼 -->
<div class="flex flex-wrap items-center justify-between mb-6 space-y-2 sm:space-y-0">
  <div class="flex items-center space-x-2">
   <select id="sourceFilter" class="border rounded px-2 py-1">
  <option value="">모든 출처</option>
  {% for src in sources %}
    <option value="{{ src }}">{{ src }}</option>
  {% endfor %}
</select>

    <select class="border rounded-md px-2 py-1 text-sm">
      <option>제목순</option>
      <option>최근순</option>
    </select>
  </div>

  <div class="flex items-center space-x-2">
    <input type="text" placeholder="제목, 내용, 출처 검색..."
           class="border px-3 py-1 rounded-md w-64 text-sm focus:outline-none focus:ring-1 focus:ring-blue-400">
    <button onclick="openUploadModal()"
            class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition">
      텍스트 / 단어 업로드
    </button>
  </div>
</div>

<!-- 텍스트 목록 -->
<div class="space-y-3">
  {% for text in texts %}
  <div class="flex justify-between items-center p-4 bg-white rounded-lg shadow-sm border hover:shadow-md transition">
    <div>
      <p class="font-medium text-gray-800">{{ text.title }}</p>
      <p class="text-sm text-gray-500">저장된 단어: {{ text.word_count }}개 · 학습 완료: 0개</p>
    <p class="text-sm text-gray-500">출처: {{ text.source }}</p>
    </div>
    <div class="flex items-center space-x-2">
      <button class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded"
        onclick="openTextModal('{{ text.id }}', '{{ text.title }}', `{{ text.content|e }}`)">읽기</button>
      <a href="/flashcards/{{ text.id }}" class="bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-1 rounded">암기카드</a>
      <a href="/test/{{ text.id }}" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-1 rounded">TEST</a>
      <button onclick="deleteText('{{ text.id }}')" class="bg-red-100 hover:bg-red-200 text-red-600 rounded px-2 py-1">🗑</button>
    </div>
  </div>
  {% endfor %}
</div>

<!-- ✅ Tailwind 기반 업로드 모달 -->
<div id="uploadModal"
     class="fixed inset-0 hidden items-center justify-center bg-black/60 z-50 backdrop-blur-sm">
  <div class="bg-white rounded-2xl shadow-xl w-[90%] max-w-3xl max-h-[90vh] overflow-y-auto p-6">
    <div class="flex justify-between items-center border-b pb-3 mb-4">
      <h3 class="text-xl font-semibold text-gray-800">텍스트 및 단어 업로드</h3>
      <button onclick="closeUploadModal()" class="text-gray-500 hover:text-gray-700 text-2xl leading-none">&times;</button>
    </div>

    <p class="text-gray-600 mb-4">텍스트를 직접 입력하거나 단어를 추가해보세요.</p>

    <!-- 탭 버튼 -->
    <div class="flex border-b mb-4">
      <button id="tabTextBtn" class="flex-1 py-2 text-center font-medium text-blue-600 border-b-2 border-blue-600"
              onclick="switchTab('text')">텍스트 업로드</button>
      <button id="tabWordBtn" class="flex-1 py-2 text-center font-medium text-gray-500 hover:text-blue-600"
              onclick="switchTab('word')">단어 업로드</button>
    </div>

    <!-- 텍스트 업로드 폼 -->
    <div id="textUploadTab" class="block">
      <form id="uploadTextForm">
        <div class="mb-3">
          <label class="block font-medium text-gray-700 mb-1">텍스트 제목</label>
          <input type="text" id="textTitle" class="w-full border rounded-md px-3 py-2" placeholder="예: 01-1 bluegil" required>
        </div>
        <div class="mb-3">
          <label class="block font-medium text-gray-700 mb-1">출처</label>
          <input type="text" id="textSource" class="w-full border rounded-md px-3 py-2" placeholder="출처를 입력하세요">
        </div>
        <div class="mb-3">
          <label class="block font-medium text-gray-700 mb-1">본문 내용</label>
          <textarea id="textContent" class="w-full border rounded-md px-3 py-2 h-40"
                    placeholder="텍스트 내용을 입력하세요"></textarea>
        </div>
        <div class="text-right">
          <button type="button" onclick="closeUploadModal()" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">취소</button>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">저장</button>
        </div>
      </form>
    </div>

    <!-- 단어 업로드 폼 -->
    <div id="wordUploadTab" class="hidden">
      <form id="uploadWordsForm">
        <div class="mb-3">
          <label class="block font-medium text-gray-700 mb-1">텍스트 선택</label>
          <select id="textSelect" class="w-full border rounded-md px-3 py-2">
            <option value="">텍스트를 선택하세요</option>
            {% for t in texts %}
              <option value="{{ t.id }}">{{ t.title }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="mb-3">
          <label class="block font-medium text-gray-700 mb-1">단어 목록 (한 줄당 하나씩)</label>
          <textarea id="wordsInput" class="w-full border rounded-md px-3 py-2 h-40"
                    placeholder="예시:\narchaeologist\t고고학자\ncodices\t(codex의 복수) 고문서\nconfederation\t조합"></textarea>
        </div>

        <div class="mt-3">
          <h6 class="font-semibold mb-2">입력된 단어 미리보기</h6>
          <table class="w-full text-sm border border-gray-300">
            <thead class="bg-gray-100">
              <tr>
                <th class="border px-2 py-1 w-12">ID</th>
                <th class="border px-2 py-1 w-1/3">단어</th>
                <th class="border px-2 py-1">뜻</th>
              </tr>
            </thead>
            <tbody id="previewTable"></tbody>
          </table>
        </div>

        <div class="text-right mt-4">
          <button type="button" onclick="closeUploadModal()" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">취소</button>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">저장</button>
        </div>
      </form>
    </div>
  </div>
</div>
<!-- ✅ 단어 관리 모달 -->
<div id="wordManagerModal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 backdrop-blur-sm">
  <div class="bg-white rounded-2xl shadow-2xl w-[90%] max-w-3xl p-8">
    <h3 class="text-xl font-semibold mb-4 text-gray-800">단어 관리</h3>

    <!-- ✅ 출처 콤보박스 -->
    <label class="block mb-2 text-gray-700">출처 선택</label>
    <select id="sourceSelector" class="border rounded px-3 py-2 w-full mb-4" onchange="loadTitlesBySource()">
      <option value="">출처를 선택하세요</option>
    </select>

    <!-- ✅ 텍스트 제목 콤보박스 -->
    <label class="block mb-2 text-gray-700">텍스트 선택</label>
    <select id="textSelector" class="border rounded px-3 py-2 w-full mb-4" onchange="loadWordsByText()">
      <option value="">제목을 선택하세요</option>
    </select>

    <!-- ✅ 단어 목록 영역 -->
    <div id="wordList" class="max-h-[50vh] overflow-y-auto border rounded p-3 bg-gray-50"></div>

    <div class="text-right mt-4">
      <button onclick="closeWordManager()" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">닫기</button>
    </div>
  </div>
</div>



<!-- ✅ 텍스트 읽기 모달 -->
<div id="textModal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 backdrop-blur-sm">
  <div class="bg-white rounded-2xl shadow-2xl w-[90%] max-w-4xl p-10 max-h-[80vh] overflow-y-auto border border-gray-200">
    
    <h3 id="modalTitle" class="text-center text-2xl font-medium mb-8 text-gray-800 tracking-tight font-['Noto_Serif']"></h3>

    <!-- ✅ 수정 버튼을 모달 안으로 이동 -->
    <div class="flex justify-end mb-3">
      <button id="editToggleBtn" onclick="toggleEditMode()" 
              class="bg-yellow-400 hover:bg-yellow-500 text-white px-3 py-1 rounded">수정</button>
    </div>

    <div id="modalContent" class="text-[17px] text-gray-700 leading-[1.9] font-['Noto_Serif'] text-justify whitespace-pre-line"></div>

    <div class="text-center mt-10">
      <button onclick="closeTextModal()" class="px-6 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg transition">닫기</button>
    </div>
  </div>
</div>


<!-- ✅ JS -->
<script>
function openUploadModal() {
  document.getElementById('uploadModal').classList.remove('hidden');
  document.getElementById('uploadModal').classList.add('flex');
}
function closeUploadModal() {
  document.getElementById('uploadModal').classList.add('hidden');
  document.getElementById('uploadModal').classList.remove('flex');
}

/* 탭 전환 */
function switchTab(tab) {
  const textTab = document.getElementById('textUploadTab');
  const wordTab = document.getElementById('wordUploadTab');
  const textBtn = document.getElementById('tabTextBtn');
  const wordBtn = document.getElementById('tabWordBtn');
  if (tab === 'text') {
    textTab.classList.remove('hidden');
    wordTab.classList.add('hidden');
    textBtn.classList.add('text-blue-600', 'border-blue-600');
    textBtn.classList.remove('text-gray-500');
    wordBtn.classList.remove('text-blue-600', 'border-blue-600');
    wordBtn.classList.add('text-gray-500');
  } else {
    textTab.classList.add('hidden');
    wordTab.classList.remove('hidden');
    wordBtn.classList.add('text-blue-600', 'border-blue-600');
    wordBtn.classList.remove('text-gray-500');
    textBtn.classList.remove('text-blue-600', 'border-blue-600');
    textBtn.classList.add('text-gray-500');
  }
}

/* 미리보기 */
const wordsInput = document.getElementById('wordsInput');
const previewBody = document.getElementById('previewTable');
if (wordsInput) {
  wordsInput.addEventListener('input', () => {
    previewBody.innerHTML = '';
    const lines = wordsInput.value.trim().split('\n').filter(l => l.trim());
    lines.forEach((line, i) => {
      const [word, meaning] = line.split(/\t| {2,}/);
      const row = `<tr><td class="border px-2 text-center">${i + 1}</td><td class="border px-2">${word || ''}</td><td class="border px-2">${meaning || ''}</td></tr>`;
      previewBody.insertAdjacentHTML('beforeend', row);
    });
  });
}

/* 텍스트 업로드 */
document.getElementById('uploadTextForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const title = document.getElementById('textTitle').value.trim();
  const source = document.getElementById('textSource').value.trim();
  const content = document.getElementById('textContent').value.trim();

  const res = await fetch('/upload_text', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ title, source, content })
  });
  const data = await res.json();
  alert(data.message || data.error);
  closeUploadModal();
  location.reload();
});

/* 단어 업로드 */
document.getElementById('uploadWordsForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const text_id = document.getElementById('textSelect').value;
  const rawText = document.getElementById('wordsInput').value.trim();
  if (!text_id || !rawText) return alert("텍스트와 단어를 모두 입력해주세요.");

  const lines = rawText.split('\n').filter(l => l.trim());
  const words = lines.map(line => {
    const [word, meaning] = line.split(/\t| {2,}/);
    return { word: word?.trim(), meaning: meaning?.trim() };
  });

  const res = await fetch('/upload_words', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ text_id, words })
  });
  const data = await res.json();
  alert(data.message || data.error);
  closeUploadModal();
  location.reload();
});
/* /* ✅ 출처 필터 동작 (공백/대소문자/줄바꿈 안전 버전) */
const sourceFilter = document.getElementById("sourceFilter");
if (sourceFilter) {
  sourceFilter.addEventListener("change", () => {
    const selected = sourceFilter.value.trim().toLowerCase();
    const cards = document.querySelectorAll(".space-y-3 > div.flex.justify-between.items-center");

    cards.forEach(card => {
      // 카드 안에서 '출처:' 문구가 포함된 줄을 가져옴
      const sourceLine = Array.from(card.querySelectorAll(".text-sm.text-gray-500"))
                              .map(el => el.textContent)
                              .find(t => t.includes("출처:")) || "";
      const cardSource = sourceLine.replace("출처:", "").trim().toLowerCase();

      // 필터링 조건
      if (!selected || cardSource === selected) {
        card.style.display = "flex";
      } else {
        card.style.display = "none";
      }
    });
  });
}

let editMode = false;

/* ✅ 읽기 모달에서 수정 모드 토글 */
function toggleEditMode() {
  const btn = document.getElementById("editToggleBtn");
  const contentDiv = document.getElementById("modalContent");
  
  if (!editMode) {
    // 수정 모드 진입
    const currentText = contentDiv.innerText.trim();
    contentDiv.innerHTML = `<textarea id="editTextarea" class="w-full border rounded-md p-3 h-96">${currentText}</textarea>
                            <div class="text-right mt-3">
                              <button onclick="saveEditedText()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">저장</button>
                            </div>`;
    btn.textContent = "취소";
    btn.classList.replace("bg-yellow-400", "bg-gray-400");
  } else {
    // 원래 읽기 모드로 복귀 (새로고침으로 복원)
    location.reload();
  }
  editMode = !editMode;
}

/* ✅ 수정 저장 */
async function saveEditedText() {
  const id = document.getElementById("modalTitle").dataset.id;  // ✅ 이 줄로 교체
  const title = document.getElementById("modalTitle").innerText;
  const content = document.getElementById("editTextarea").value.trim();

  const res = await fetch("/update_text", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ id, title, content })
  });

  const data = await res.json();
  alert(data.message || data.error);
  location.reload();
}
/* ✅ 단어 관리 모달 열기 */
async function openWordManager() {
  const modal = document.getElementById("wordManagerModal");
  modal.classList.remove("hidden");

  // 출처 리스트 불러오기
  const res = await fetch("/get_sources");
const sources = await res.json();
const selector = document.getElementById("sourceSelector");
selector.innerHTML = '<option value="">출처를 선택하세요</option>';
sources.forEach(s => {
  selector.innerHTML += `<option value="${s.source}">${s.source}</option>`;
});


  // 제목 초기화
  document.getElementById("textSelector").innerHTML = '<option value="">제목을 선택하세요</option>';
  document.getElementById("wordList").innerHTML = "";
}

/* ✅ 모달 닫기 */
function closeWordManager() {
  document.getElementById("wordManagerModal").classList.add("hidden");
}

/* ✅ 출처 선택 시 제목 목록 불러오기 */
async function loadTitlesBySource() {
  const source = document.getElementById("sourceSelector").value;
  const selector = document.getElementById("textSelector");

  if (!source) {
    selector.innerHTML = '<option value="">제목을 선택하세요</option>';
    return;
  }

  const res = await fetch(`/get_titles_by_source/${encodeURIComponent(source)}`);
  const titles = await res.json();

  selector.innerHTML = '<option value="">제목을 선택하세요</option>';
  titles.forEach(t => {
    selector.innerHTML += `<option value="${t.id}">${t.title}</option>`;
  });

  document.getElementById("wordList").innerHTML = "";
}


/* ✅ 제목 선택 시 단어 목록 불러오기 */
async function loadWordsByText() {
  const textId = document.getElementById("textSelector").value;
  if (!textId) return;

  const res = await fetch(`/get_words_by_text/${textId}`);
  const data = await res.json();

  const list = document.getElementById("wordList");
  if (data.length === 0) {
    list.innerHTML = "<p class='text-gray-500'>저장된 단어가 없습니다.</p>";
    return;
  }

  list.innerHTML = data.map(w => `
    <div class="flex justify-between items-center mb-2 bg-white border rounded p-2">
      <input value="${w.word}" class="border px-2 py-1 rounded w-1/3" id="word-${w.id}">
      <input value="${w.meaning}" class="border px-2 py-1 rounded w-1/2" id="meaning-${w.id}">
      <div class="flex space-x-2">
        <button class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" onclick="updateWord('${w.id}')">수정</button>
        <button class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded" onclick="deleteWord('${w.id}')">삭제</button>
      </div>
    </div>
  `).join('');
}

/* ✅ 단어 수정 */
async function updateWord(id) {
  const word = document.getElementById(`word-${id}`).value.trim();
  const meaning = document.getElementById(`meaning-${id}`).value.trim();
  const res = await fetch("/update_word", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ id, word, meaning })
  });
  const data = await res.json();
  alert(data.message || data.error);
}

/* ✅ 단어 삭제 */
async function deleteWord(id) {
  if (!confirm("정말 이 단어를 삭제하시겠습니까?")) return;
  const res = await fetch(`/delete_word/${id}`, { method: "DELETE" });
  const data = await res.json();
  alert(data.message || data.error);
  loadWordsByText(); // 새로고침
}


/* 텍스트 보기 모달 */
function openTextModal(id, title, content) {
  const modal = document.getElementById('textModal');
  const modalTitle = document.getElementById('modalTitle');
  const modalContent = document.getElementById('modalContent');

  modalTitle.setAttribute('data-id', id);  // ✅ id 저장
  modalTitle.innerText = title;

  const paragraphs = content.split('\n').filter(p => p.trim() !== '');
  modalContent.innerHTML = `<div style="white-space: pre-line; line-height:1.9;" class="text-[17px] text-gray-700 font-['Noto_Serif']">${content}</div>`;
  modal.classList.remove('hidden');
}

function closeTextModal() {
  document.getElementById('textModal').classList.add('hidden');
}
</script>

{% endblock %}
