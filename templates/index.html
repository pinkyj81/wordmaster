{% extends "base.html" %}
{% block content %}

<h2 class="text-2xl font-semibold mb-6 text-gray-800">í…ìŠ¤íŠ¸ ê¸°ë¡</h2>

<!-- ìƒë‹¨ í•„í„°/ê²€ìƒ‰ + ì—…ë¡œë“œ ë²„íŠ¼ -->
<div class="flex flex-wrap items-center justify-between mb-6 space-y-2 sm:space-y-0">
  <div class="flex items-center space-x-2">
   <select id="sourceFilter" class="border rounded px-2 py-1">
  <option value="">ëª¨ë“  ì¶œì²˜</option>
  {% for src in sources %}
    <option value="{{ src }}">{{ src }}</option>
  {% endfor %}
</select>

    <select class="border rounded-md px-2 py-1 text-sm">
      <option>ì œëª©ìˆœ</option>
      <option>ìµœê·¼ìˆœ</option>
    </select>
  </div>

  <div class="flex items-center space-x-2">
    <input type="text" placeholder="ì œëª©, ë‚´ìš©, ì¶œì²˜ ê²€ìƒ‰..."
           class="border px-3 py-1 rounded-md w-64 text-sm focus:outline-none focus:ring-1 focus:ring-blue-400">
    <button onclick="openUploadModal()"
            class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition">
      í…ìŠ¤íŠ¸ / ë‹¨ì–´ ì—…ë¡œë“œ
    </button>
  </div>
</div>

<!-- í…ìŠ¤íŠ¸ ëª©ë¡ -->
<div class="space-y-3">
  {% for text in texts %}
  <div class="flex justify-between items-center p-4 bg-white rounded-lg shadow-sm border hover:shadow-md transition">
    <div>
      <p class="font-medium text-gray-800">{{ text.title }}</p>
      <p class="text-sm text-gray-500">ì €ì¥ëœ ë‹¨ì–´: {{ text.word_count }}ê°œ Â· í•™ìŠµ ì™„ë£Œ: 0ê°œ</p>
    <p class="text-sm text-gray-500">ì¶œì²˜: {{ text.source }}</p>
    </div>
    <div class="flex items-center space-x-2">
      <button class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded"
        onclick="openTextModal('{{ text.id }}', '{{ text.title }}', `{{ text.content|e }}`)">ì½ê¸°</button>
      <a href="/flashcards/{{ text.id }}" class="bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-1 rounded">ì•”ê¸°ì¹´ë“œ</a>
      <a href="/test/{{ text.id }}" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-1 rounded">TEST</a>
      <button onclick="deleteText('{{ text.id }}')" class="bg-red-100 hover:bg-red-200 text-red-600 rounded px-2 py-1">ğŸ—‘</button>
    </div>
  </div>
  {% endfor %}
</div>

<!-- âœ… Tailwind ê¸°ë°˜ ì—…ë¡œë“œ ëª¨ë‹¬ -->
<div id="uploadModal"
     class="fixed inset-0 hidden items-center justify-center bg-black/60 z-50 backdrop-blur-sm">
  <div class="bg-white rounded-2xl shadow-xl w-[90%] max-w-3xl max-h-[90vh] overflow-y-auto p-6">
    <div class="flex justify-between items-center border-b pb-3 mb-4">
      <h3 class="text-xl font-semibold text-gray-800">í…ìŠ¤íŠ¸ ë° ë‹¨ì–´ ì—…ë¡œë“œ</h3>
      <button onclick="closeUploadModal()" class="text-gray-500 hover:text-gray-700 text-2xl leading-none">&times;</button>
    </div>

    <p class="text-gray-600 mb-4">í…ìŠ¤íŠ¸ë¥¼ ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ ë‹¨ì–´ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”.</p>

    <!-- íƒ­ ë²„íŠ¼ -->
    <div class="flex border-b mb-4">
      <button id="tabTextBtn" class="flex-1 py-2 text-center font-medium text-blue-600 border-b-2 border-blue-600"
              onclick="switchTab('text')">í…ìŠ¤íŠ¸ ì—…ë¡œë“œ</button>
      <button id="tabWordBtn" class="flex-1 py-2 text-center font-medium text-gray-500 hover:text-blue-600"
              onclick="switchTab('word')">ë‹¨ì–´ ì—…ë¡œë“œ</button>
    </div>

    <!-- í…ìŠ¤íŠ¸ ì—…ë¡œë“œ í¼ -->
    <div id="textUploadTab" class="block">
      <form id="uploadTextForm">
        <div class="mb-3">
          <label class="block font-medium text-gray-700 mb-1">í…ìŠ¤íŠ¸ ì œëª©</label>
          <input type="text" id="textTitle" class="w-full border rounded-md px-3 py-2" placeholder="ì˜ˆ: 01-1 bluegil" required>
        </div>
        <div class="mb-3">
          <label class="block font-medium text-gray-700 mb-1">ì¶œì²˜</label>
          <input type="text" id="textSource" class="w-full border rounded-md px-3 py-2" placeholder="ì¶œì²˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
        </div>
        <div class="mb-3">
          <label class="block font-medium text-gray-700 mb-1">ë³¸ë¬¸ ë‚´ìš©</label>
          <textarea id="textContent" class="w-full border rounded-md px-3 py-2 h-40"
                    placeholder="í…ìŠ¤íŠ¸ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
        </div>
        <div class="text-right">
          <button type="button" onclick="closeUploadModal()" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">ì·¨ì†Œ</button>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">ì €ì¥</button>
        </div>
      </form>
    </div>

    <!-- ë‹¨ì–´ ì—…ë¡œë“œ í¼ -->
    <div id="wordUploadTab" class="hidden">
      <form id="uploadWordsForm">
        <div class="mb-3">
          <label class="block font-medium text-gray-700 mb-1">í…ìŠ¤íŠ¸ ì„ íƒ</label>
          <select id="textSelect" class="w-full border rounded-md px-3 py-2">
            <option value="">í…ìŠ¤íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
            {% for t in texts %}
              <option value="{{ t.id }}">{{ t.title }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="mb-3">
          <label class="block font-medium text-gray-700 mb-1">ë‹¨ì–´ ëª©ë¡ (í•œ ì¤„ë‹¹ í•˜ë‚˜ì”©)</label>
          <textarea id="wordsInput" class="w-full border rounded-md px-3 py-2 h-40"
                    placeholder="ì˜ˆì‹œ:\narchaeologist\tê³ ê³ í•™ì\ncodices\t(codexì˜ ë³µìˆ˜) ê³ ë¬¸ì„œ\nconfederation\tì¡°í•©"></textarea>
        </div>

        <div class="mt-3">
          <h6 class="font-semibold mb-2">ì…ë ¥ëœ ë‹¨ì–´ ë¯¸ë¦¬ë³´ê¸°</h6>
          <table class="w-full text-sm border border-gray-300">
            <thead class="bg-gray-100">
              <tr>
                <th class="border px-2 py-1 w-12">ID</th>
                <th class="border px-2 py-1 w-1/3">ë‹¨ì–´</th>
                <th class="border px-2 py-1">ëœ»</th>
              </tr>
            </thead>
            <tbody id="previewTable"></tbody>
          </table>
        </div>

        <div class="text-right mt-4">
          <button type="button" onclick="closeUploadModal()" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">ì·¨ì†Œ</button>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">ì €ì¥</button>
        </div>
      </form>
    </div>
  </div>
</div>
<!-- âœ… ë‹¨ì–´ ê´€ë¦¬ ëª¨ë‹¬ -->
<div id="wordManagerModal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 backdrop-blur-sm">
  <div class="bg-white rounded-2xl shadow-2xl w-[90%] max-w-3xl p-8">
    <h3 class="text-xl font-semibold mb-4 text-gray-800">ë‹¨ì–´ ê´€ë¦¬</h3>

    <!-- âœ… ì¶œì²˜ ì½¤ë³´ë°•ìŠ¤ -->
    <label class="block mb-2 text-gray-700">ì¶œì²˜ ì„ íƒ</label>
    <select id="sourceSelector" class="border rounded px-3 py-2 w-full mb-4" onchange="loadTitlesBySource()">
      <option value="">ì¶œì²˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
    </select>

    <!-- âœ… í…ìŠ¤íŠ¸ ì œëª© ì½¤ë³´ë°•ìŠ¤ -->
    <label class="block mb-2 text-gray-700">í…ìŠ¤íŠ¸ ì„ íƒ</label>
    <select id="textSelector" class="border rounded px-3 py-2 w-full mb-4" onchange="loadWordsByText()">
      <option value="">ì œëª©ì„ ì„ íƒí•˜ì„¸ìš”</option>
    </select>

    <!-- âœ… ë‹¨ì–´ ëª©ë¡ ì˜ì—­ -->
    <div id="wordList" class="max-h-[50vh] overflow-y-auto border rounded p-3 bg-gray-50"></div>

    <div class="text-right mt-4">
      <button onclick="closeWordManager()" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">ë‹«ê¸°</button>
    </div>
  </div>
</div>



<!-- âœ… í…ìŠ¤íŠ¸ ì½ê¸° ëª¨ë‹¬ -->
<div id="textModal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 backdrop-blur-sm">
  <div class="bg-white rounded-2xl shadow-2xl w-[90%] max-w-4xl p-10 max-h-[80vh] overflow-y-auto border border-gray-200">
    
    <h3 id="modalTitle" class="text-center text-2xl font-medium mb-8 text-gray-800 tracking-tight font-['Noto_Serif']"></h3>

    <!-- âœ… ìˆ˜ì • ë²„íŠ¼ì„ ëª¨ë‹¬ ì•ˆìœ¼ë¡œ ì´ë™ -->
    <div class="flex justify-end mb-3">
      <button id="editToggleBtn" onclick="toggleEditMode()" 
              class="bg-yellow-400 hover:bg-yellow-500 text-white px-3 py-1 rounded">ìˆ˜ì •</button>
    </div>

    <div id="modalContent" class="text-[17px] text-gray-700 leading-[1.9] font-['Noto_Serif'] text-justify whitespace-pre-line"></div>

    <div class="text-center mt-10">
      <button onclick="closeTextModal()" class="px-6 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg transition">ë‹«ê¸°</button>
    </div>
  </div>
</div>


<!-- âœ… JS -->
<script>
function openUploadModal() {
  document.getElementById('uploadModal').classList.remove('hidden');
  document.getElementById('uploadModal').classList.add('flex');
}
function closeUploadModal() {
  document.getElementById('uploadModal').classList.add('hidden');
  document.getElementById('uploadModal').classList.remove('flex');
}

/* íƒ­ ì „í™˜ */
function switchTab(tab) {
  const textTab = document.getElementById('textUploadTab');
  const wordTab = document.getElementById('wordUploadTab');
  const textBtn = document.getElementById('tabTextBtn');
  const wordBtn = document.getElementById('tabWordBtn');
  if (tab === 'text') {
    textTab.classList.remove('hidden');
    wordTab.classList.add('hidden');
    textBtn.classList.add('text-blue-600', 'border-blue-600');
    textBtn.classList.remove('text-gray-500');
    wordBtn.classList.remove('text-blue-600', 'border-blue-600');
    wordBtn.classList.add('text-gray-500');
  } else {
    textTab.classList.add('hidden');
    wordTab.classList.remove('hidden');
    wordBtn.classList.add('text-blue-600', 'border-blue-600');
    wordBtn.classList.remove('text-gray-500');
    textBtn.classList.remove('text-blue-600', 'border-blue-600');
    textBtn.classList.add('text-gray-500');
  }
}

/* ë¯¸ë¦¬ë³´ê¸° */
const wordsInput = document.getElementById('wordsInput');
const previewBody = document.getElementById('previewTable');
if (wordsInput) {
  wordsInput.addEventListener('input', () => {
    previewBody.innerHTML = '';
    const lines = wordsInput.value.trim().split('\n').filter(l => l.trim());
    lines.forEach((line, i) => {
      const [word, meaning] = line.split(/\t| {2,}/);
      const row = `<tr><td class="border px-2 text-center">${i + 1}</td><td class="border px-2">${word || ''}</td><td class="border px-2">${meaning || ''}</td></tr>`;
      previewBody.insertAdjacentHTML('beforeend', row);
    });
  });
}

/* í…ìŠ¤íŠ¸ ì—…ë¡œë“œ */
document.getElementById('uploadTextForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const title = document.getElementById('textTitle').value.trim();
  const source = document.getElementById('textSource').value.trim();
  const content = document.getElementById('textContent').value.trim();

  const res = await fetch('/upload_text', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ title, source, content })
  });
  const data = await res.json();
  alert(data.message || data.error);
  closeUploadModal();
  location.reload();
});

/* ë‹¨ì–´ ì—…ë¡œë“œ */
document.getElementById('uploadWordsForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const text_id = document.getElementById('textSelect').value;
  const rawText = document.getElementById('wordsInput').value.trim();
  if (!text_id || !rawText) return alert("í…ìŠ¤íŠ¸ì™€ ë‹¨ì–´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");

  const lines = rawText.split('\n').filter(l => l.trim());
  const words = lines.map(line => {
    const [word, meaning] = line.split(/\t| {2,}/);
    return { word: word?.trim(), meaning: meaning?.trim() };
  });

  const res = await fetch('/upload_words', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ text_id, words })
  });
  const data = await res.json();
  alert(data.message || data.error);
  closeUploadModal();
  location.reload();
});
/* /* âœ… ì¶œì²˜ í•„í„° ë™ì‘ (ê³µë°±/ëŒ€ì†Œë¬¸ì/ì¤„ë°”ê¿ˆ ì•ˆì „ ë²„ì „) */
const sourceFilter = document.getElementById("sourceFilter");
if (sourceFilter) {
  sourceFilter.addEventListener("change", () => {
    const selected = sourceFilter.value.trim().toLowerCase();
    const cards = document.querySelectorAll(".space-y-3 > div.flex.justify-between.items-center");

    cards.forEach(card => {
      // ì¹´ë“œ ì•ˆì—ì„œ 'ì¶œì²˜:' ë¬¸êµ¬ê°€ í¬í•¨ëœ ì¤„ì„ ê°€ì ¸ì˜´
      const sourceLine = Array.from(card.querySelectorAll(".text-sm.text-gray-500"))
                              .map(el => el.textContent)
                              .find(t => t.includes("ì¶œì²˜:")) || "";
      const cardSource = sourceLine.replace("ì¶œì²˜:", "").trim().toLowerCase();

      // í•„í„°ë§ ì¡°ê±´
      if (!selected || cardSource === selected) {
        card.style.display = "flex";
      } else {
        card.style.display = "none";
      }
    });
  });
}

let editMode = false;

/* âœ… ì½ê¸° ëª¨ë‹¬ì—ì„œ ìˆ˜ì • ëª¨ë“œ í† ê¸€ */
function toggleEditMode() {
  const btn = document.getElementById("editToggleBtn");
  const contentDiv = document.getElementById("modalContent");
  
  if (!editMode) {
    // ìˆ˜ì • ëª¨ë“œ ì§„ì…
    const currentText = contentDiv.innerText.trim();
    contentDiv.innerHTML = `<textarea id="editTextarea" class="w-full border rounded-md p-3 h-96">${currentText}</textarea>
                            <div class="text-right mt-3">
                              <button onclick="saveEditedText()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">ì €ì¥</button>
                            </div>`;
    btn.textContent = "ì·¨ì†Œ";
    btn.classList.replace("bg-yellow-400", "bg-gray-400");
  } else {
    // ì›ë˜ ì½ê¸° ëª¨ë“œë¡œ ë³µê·€ (ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ë³µì›)
    location.reload();
  }
  editMode = !editMode;
}

/* âœ… ìˆ˜ì • ì €ì¥ */
async function saveEditedText() {
  const id = document.getElementById("modalTitle").dataset.id;  // âœ… ì´ ì¤„ë¡œ êµì²´
  const title = document.getElementById("modalTitle").innerText;
  const content = document.getElementById("editTextarea").value.trim();

  const res = await fetch("/update_text", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ id, title, content })
  });

  const data = await res.json();
  alert(data.message || data.error);
  location.reload();
}
/* âœ… ë‹¨ì–´ ê´€ë¦¬ ëª¨ë‹¬ ì—´ê¸° */
async function openWordManager() {
  const modal = document.getElementById("wordManagerModal");
  modal.classList.remove("hidden");

  // ì¶œì²˜ ë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°
  const res = await fetch("/get_sources");
const sources = await res.json();
const selector = document.getElementById("sourceSelector");
selector.innerHTML = '<option value="">ì¶œì²˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
sources.forEach(s => {
  selector.innerHTML += `<option value="${s.source}">${s.source}</option>`;
});


  // ì œëª© ì´ˆê¸°í™”
  document.getElementById("textSelector").innerHTML = '<option value="">ì œëª©ì„ ì„ íƒí•˜ì„¸ìš”</option>';
  document.getElementById("wordList").innerHTML = "";
}

/* âœ… ëª¨ë‹¬ ë‹«ê¸° */
function closeWordManager() {
  document.getElementById("wordManagerModal").classList.add("hidden");
}

/* âœ… ì¶œì²˜ ì„ íƒ ì‹œ ì œëª© ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° */
async function loadTitlesBySource() {
  const source = document.getElementById("sourceSelector").value;
  const selector = document.getElementById("textSelector");

  if (!source) {
    selector.innerHTML = '<option value="">ì œëª©ì„ ì„ íƒí•˜ì„¸ìš”</option>';
    return;
  }

  const res = await fetch(`/get_titles_by_source/${encodeURIComponent(source)}`);
  const titles = await res.json();

  selector.innerHTML = '<option value="">ì œëª©ì„ ì„ íƒí•˜ì„¸ìš”</option>';
  titles.forEach(t => {
    selector.innerHTML += `<option value="${t.id}">${t.title}</option>`;
  });

  document.getElementById("wordList").innerHTML = "";
}


/* âœ… ì œëª© ì„ íƒ ì‹œ ë‹¨ì–´ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° */
async function loadWordsByText() {
  const textId = document.getElementById("textSelector").value;
  if (!textId) return;

  const res = await fetch(`/get_words_by_text/${textId}`);
  const data = await res.json();

  const list = document.getElementById("wordList");
  if (data.length === 0) {
    list.innerHTML = "<p class='text-gray-500'>ì €ì¥ëœ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
    return;
  }

  list.innerHTML = data.map(w => `
    <div class="flex justify-between items-center mb-2 bg-white border rounded p-2">
      <input value="${w.word}" class="border px-2 py-1 rounded w-1/3" id="word-${w.id}">
      <input value="${w.meaning}" class="border px-2 py-1 rounded w-1/2" id="meaning-${w.id}">
      <div class="flex space-x-2">
        <button class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" onclick="updateWord('${w.id}')">ìˆ˜ì •</button>
        <button class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded" onclick="deleteWord('${w.id}')">ì‚­ì œ</button>
      </div>
    </div>
  `).join('');
}

/* âœ… ë‹¨ì–´ ìˆ˜ì • */
async function updateWord(id) {
  const word = document.getElementById(`word-${id}`).value.trim();
  const meaning = document.getElementById(`meaning-${id}`).value.trim();
  const res = await fetch("/update_word", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ id, word, meaning })
  });
  const data = await res.json();
  alert(data.message || data.error);
}

/* âœ… ë‹¨ì–´ ì‚­ì œ */
async function deleteWord(id) {
  if (!confirm("ì •ë§ ì´ ë‹¨ì–´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
  const res = await fetch(`/delete_word/${id}`, { method: "DELETE" });
  const data = await res.json();
  alert(data.message || data.error);
  loadWordsByText(); // ìƒˆë¡œê³ ì¹¨
}


/* í…ìŠ¤íŠ¸ ë³´ê¸° ëª¨ë‹¬ */
function openTextModal(id, title, content) {
  const modal = document.getElementById('textModal');
  const modalTitle = document.getElementById('modalTitle');
  const modalContent = document.getElementById('modalContent');

  modalTitle.setAttribute('data-id', id);  // âœ… id ì €ì¥
  modalTitle.innerText = title;

  const paragraphs = content.split('\n').filter(p => p.trim() !== '');
  modalContent.innerHTML = `<div style="white-space: pre-line; line-height:1.9;" class="text-[17px] text-gray-700 font-['Noto_Serif']">${content}</div>`;
  modal.classList.remove('hidden');
}

function closeTextModal() {
  document.getElementById('textModal').classList.add('hidden');
}
</script>

{% endblock %}
