{% extends "base.html" %}
{% block content %}

<h2 class="text-3xl font-bold mb-6 text-gray-800">ğŸ“ ìŠ¤í ë§ í…ŒìŠ¤íŠ¸</h2>

<div class="mb-6">
  <p class="text-gray-600 mb-4">í•œê¸€ ëœ»ì„ ë³´ê³  ì˜ì–´ ë‹¨ì–´ë¥¼ ìŠ¤í ë§í•˜ì„¸ìš”. ì²« ê¸€ìëŠ” íŒíŠ¸ë¡œ ì œê³µë©ë‹ˆë‹¤.</p>
  
  <!-- í…ìŠ¤íŠ¸ ì„ íƒ -->
  <div class="mb-4">
    <label class="block mb-2 text-gray-700 font-medium">í…ìŠ¤íŠ¸ ì„ íƒ</label>
    <select id="textSelector" class="border rounded px-3 py-2 w-full max-w-md">
      <option value="">í…ìŠ¤íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
      {% for text in texts %}
        <option value="{{ text.id }}">{{ text.title }}</option>
      {% endfor %}
    </select>
  </div>

  <!-- ì‹œì‘ ë²„íŠ¼ -->
  <button onclick="startSpellingTest()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition font-semibold">
    ì‹œì‘í•˜ê¸°
  </button>
</div>

<!-- í…ŒìŠ¤íŠ¸ ì˜ì—­ -->
<div id="testArea" class="hidden">
  <div class="bg-white rounded-lg shadow-lg p-8 max-w-2xl mx-auto">
    <!-- ì§„í–‰ ìƒí™© -->
    <div class="mb-6">
      <div class="flex justify-between text-sm text-gray-600 mb-2">
        <span>ë¬¸ì œ <span id="currentNum">1</span> / <span id="totalNum">0</span></span>
        <span>ì •ë‹µ: <span id="correctCount" class="text-green-600 font-bold">0</span> / ì˜¤ë‹µ: <span id="wrongCount" class="text-red-600 font-bold">0</span></span>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-2">
        <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all" style="width: 0%"></div>
      </div>
    </div>

    <!-- ë¬¸ì œ -->
    <div class="text-center mb-8">
      <p class="text-gray-500 text-sm mb-2">ëœ»</p>
      <h3 id="meaningText" class="text-3xl font-bold text-gray-800 mb-6">ì‚¬ê³¼</h3>
      
      <!-- ìŠ¤í ë§ ì…ë ¥ ì¹¸ -->
      <div id="letterBoxes" class="flex justify-center gap-2 mb-4">
        <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
      </div>
      
      <p id="feedbackMsg" class="text-sm min-h-6"></p>
    </div>

    <!-- ë²„íŠ¼ -->
    <div class="flex justify-center gap-3">
      <button onclick="checkAnswer()" id="submitBtn" class="bg-green-600 text-white px-8 py-3 rounded-lg hover:bg-green-700 transition font-semibold">
        í™•ì¸
      </button>
      <button onclick="skipQuestion()" class="bg-yellow-600 text-white px-8 py-3 rounded-lg hover:bg-yellow-700 transition font-semibold">
        ê±´ë„ˆë›°ê¸°
      </button>
      <button onclick="endTest()" class="bg-red-600 text-white px-8 py-3 rounded-lg hover:bg-red-700 transition font-semibold">
        ì¢…ë£Œ
      </button>
    </div>
  </div>
</div>

<!-- ê²°ê³¼ ëª¨ë‹¬ -->
<div id="resultModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
  <div class="bg-white rounded-2xl shadow-2xl w-[500px] p-8">
    <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">í…ŒìŠ¤íŠ¸ ê²°ê³¼</h3>
    
    <div class="space-y-4 mb-6">
      <div class="flex justify-between text-lg">
        <span>ì´ ë¬¸ì œ:</span>
        <span class="font-bold" id="resultTotal">0</span>
      </div>
      <div class="flex justify-between text-lg">
        <span>ì •ë‹µ:</span>
        <span class="font-bold text-green-600" id="resultCorrect">0</span>
      </div>
      <div class="flex justify-between text-lg">
        <span>ì˜¤ë‹µ:</span>
        <span class="font-bold text-red-600" id="resultWrong">0</span>
      </div>
      <div class="flex justify-between text-2xl border-t pt-4">
        <span>ì ìˆ˜:</span>
        <span class="font-bold text-blue-600" id="resultScore">0</span>
      </div>
    </div>

    <!-- ì˜¤ë‹µ ë¦¬ìŠ¤íŠ¸ -->
    <div id="wrongAnswersSection" class="mb-6 hidden">
      <h4 class="font-bold text-gray-700 mb-3">í‹€ë¦° ë¬¸ì œ</h4>
      <div id="wrongAnswersList" class="space-y-2 max-h-60 overflow-y-auto">
        <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
      </div>
    </div>

    <div class="flex gap-3">
      <button onclick="closeResultModal()" class="flex-1 bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition font-semibold">
        ë‹«ê¸°
      </button>
      <button onclick="restartTest()" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition font-semibold">
        ë‹¤ì‹œ ì‹œì‘
      </button>
    </div>
  </div>
</div>

<script>
let words = [];
let currentIndex = 0;
let correctCount = 0;
let wrongCount = 0;
let currentAnswer = '';
let wrongAnswers = [];
let startTime = null;
let testTextId = '';
let testTextTitle = '';
let resultSaved = false;

async function startSpellingTest() {
  const textId = document.getElementById('textSelector').value;
  
  if (!textId) {
    alert('í…ìŠ¤íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
    return;
  }

  try {
    const response = await fetch(`/api/spelling_test/words/${textId}`);
    const data = await response.json();
    
    // API ì‘ë‹µ êµ¬ì¡° ë³€ê²½ ë°˜ì˜
    words = data.words || [];
    const totalUnlearned = data.total_unlearned || 0;
    const selectedCount = data.selected_count || 0;
    
    if (words.length === 0) {
      alert('ì•”ê¸°í•˜ì§€ ì•Šì€ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤. ëª¨ë“  ë‹¨ì–´ë¥¼ ë‹¤ ì™¸ì› ë„¤ìš”!');
      return;
    }

    // ë‹¨ì–´ ê°œìˆ˜ ì•Œë¦¼
    if (totalUnlearned <= 10) {
      alert(`ì•”ê¸°í•˜ì§€ ì•Šì€ ë‹¨ì–´ê°€ ì´ ${totalUnlearned}ê°œì…ë‹ˆë‹¤.\nëª¨ë“  ë‹¨ì–´ê°€ ì¶œì œë©ë‹ˆë‹¤.`);
    } else {
      console.log(`ì•”ê¸°í•˜ì§€ ì•Šì€ ë‹¨ì–´ ${totalUnlearned}ê°œ ì¤‘ ëœë¤ìœ¼ë¡œ ${selectedCount}ê°œ ì„ íƒë¨`);
    }

    // ì´ë¯¸ ëœë¤ìœ¼ë¡œ ì„ íƒë˜ì–´ ì™”ìœ¼ë¯€ë¡œ ì¶”ê°€ ì„ê¸° ë¶ˆí•„ìš”
    
    // í…ŒìŠ¤íŠ¸ ì •ë³´ ì €ì¥
    testTextId = textId;
    const selector = document.getElementById('textSelector');
    testTextTitle = selector.options[selector.selectedIndex].text;
    startTime = Date.now();
    resultSaved = false;
    
    currentIndex = 0;
    correctCount = 0;
    wrongCount = 0;
    wrongAnswers = [];
    
    document.getElementById('testArea').classList.remove('hidden');
    document.getElementById('totalNum').textContent = words.length;
    
    showQuestion();
  } catch (error) {
    console.error('ë‹¨ì–´ ë¡œë“œ ì‹¤íŒ¨:', error);
    alert('ë‹¨ì–´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

function showQuestion() {
  if (currentIndex >= words.length) {
    showResult();
    return;
  }

  const word = words[currentIndex];
  currentAnswer = word.word;
  
  // ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
  document.getElementById('currentNum').textContent = currentIndex + 1;
  document.getElementById('correctCount').textContent = correctCount;
  document.getElementById('wrongCount').textContent = wrongCount;
  
  const progress = ((currentIndex) / words.length) * 100;
  document.getElementById('progressBar').style.width = progress + '%';
  
  // ëœ» í‘œì‹œ
  document.getElementById('meaningText').textContent = word.meaning;
  
  // ì…ë ¥ ì¹¸ ìƒì„± (ì²« ê¸€ìëŠ” íŒíŠ¸ë¡œ í‘œì‹œ)
  const letterBoxes = document.getElementById('letterBoxes');
  letterBoxes.innerHTML = '';
  
  for (let i = 0; i < word.length; i++) {
    const input = document.createElement('input');
    input.type = 'text';
    input.maxLength = 1;
    input.className = 'w-12 h-12 text-center text-2xl font-bold border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none uppercase';
    input.dataset.index = i;
    
    if (i === 0) {
      // ì²« ê¸€ìëŠ” íŒíŠ¸ë¡œ í‘œì‹œ
      input.value = word.word[0];
      input.readOnly = true;
      input.className += ' bg-blue-100 text-blue-600';
    } else {
      // ë‹¤ìŒ ì¹¸ìœ¼ë¡œ ìë™ ì´ë™
      input.addEventListener('input', function(e) {
        if (e.target.value) {
          const nextInput = document.querySelector(`input[data-index="${parseInt(e.target.dataset.index) + 1}"]`);
          if (nextInput) {
            nextInput.focus();
          }
        }
      });
      
      // Backspaceë¡œ ì´ì „ ì¹¸ìœ¼ë¡œ ì´ë™
      input.addEventListener('keydown', function(e) {
        if (e.key === 'Backspace' && !e.target.value) {
          const prevInput = document.querySelector(`input[data-index="${parseInt(e.target.dataset.index) - 1}"]`);
          if (prevInput && !prevInput.readOnly) {
            prevInput.focus();
          }
        } else if (e.key === 'Enter') {
          checkAnswer();
        }
      });
    }
    
    letterBoxes.appendChild(input);
  }
  
  // ì²« ì…ë ¥ ì¹¸ì— í¬ì»¤ìŠ¤ (ë‘ ë²ˆì§¸ ì¹¸)
  const firstEditableInput = letterBoxes.querySelector('input:not([readonly])');
  if (firstEditableInput) {
    setTimeout(() => firstEditableInput.focus(), 100);
  }
  
  document.getElementById('feedbackMsg').textContent = '';
  document.getElementById('feedbackMsg').className = 'text-sm min-h-6';
}

function checkAnswer() {
  const inputs = document.querySelectorAll('#letterBoxes input');
  let userAnswer = '';
  
  inputs.forEach(input => {
    userAnswer += input.value.toLowerCase();
  });
  
  const feedbackMsg = document.getElementById('feedbackMsg');
  
  if (userAnswer === currentAnswer.toLowerCase()) {
    correctCount++;
    feedbackMsg.textContent = 'âœ… ì •ë‹µì…ë‹ˆë‹¤!';
    feedbackMsg.className = 'text-sm min-h-6 text-green-600 font-bold';
    
    // ì…ë ¥ ì¹¸ ì´ˆë¡ìƒ‰ìœ¼ë¡œ
    inputs.forEach(input => {
      input.className = input.className.replace('border-gray-300', 'border-green-500');
    });
    
    setTimeout(() => {
      currentIndex++;
      showQuestion();
    }, 1000);
  } else {
    wrongCount++;
    wrongAnswers.push({
      meaning: words[currentIndex].meaning,
      correct: currentAnswer,
      user: userAnswer
    });
    
    feedbackMsg.textContent = `âŒ ì˜¤ë‹µì…ë‹ˆë‹¤. ì •ë‹µ: ${currentAnswer}`;
    feedbackMsg.className = 'text-sm min-h-6 text-red-600 font-bold';
    
    // ì…ë ¥ ì¹¸ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ
    inputs.forEach(input => {
      input.className = input.className.replace('border-gray-300', 'border-red-500');
    });
    
    setTimeout(() => {
      currentIndex++;
      showQuestion();
    }, 2000);
  }
}

function skipQuestion() {
  wrongAnswers.push({
    meaning: words[currentIndex].meaning,
    correct: currentAnswer,
    user: '(ê±´ë„ˆëœ€)'
  });
  
  currentIndex++;
  showQuestion();
}

function endTest() {
  if (confirm('í…ŒìŠ¤íŠ¸ë¥¼ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
    showResult();
  }
}

async function showResult() {
  const total = correctCount + wrongCount;
  const score = total > 0 ? Math.round((correctCount / total) * 100) : 0;
  
  document.getElementById('resultTotal').textContent = total;
  document.getElementById('resultCorrect').textContent = correctCount;
  document.getElementById('resultWrong').textContent = wrongCount;
  document.getElementById('resultScore').textContent = score + 'ì ';
  
  // ì˜¤ë‹µ ë¦¬ìŠ¤íŠ¸
  if (wrongAnswers.length > 0) {
    document.getElementById('wrongAnswersSection').classList.remove('hidden');
    const wrongList = document.getElementById('wrongAnswersList');
    wrongList.innerHTML = '';
    
    wrongAnswers.forEach(item => {
      const div = document.createElement('div');
      div.className = 'p-3 bg-red-50 rounded-lg';
      div.innerHTML = `
        <div class="font-bold text-gray-800">${item.meaning}</div>
        <div class="text-sm text-gray-600">ì •ë‹µ: <span class="text-green-600 font-bold">${item.correct}</span></div>
        <div class="text-sm text-gray-600">ì…ë ¥: <span class="text-red-600 font-bold">${item.user}</span></div>
      `;
      wrongList.appendChild(div);
    });
  } else {
    document.getElementById('wrongAnswersSection').classList.add('hidden');
  }
  
  // ê²°ê³¼ ì €ì¥ (ì¤‘ë³µ ë°©ì§€)
  if (!resultSaved) {
    await saveTestResult(total, score);
    resultSaved = true;
  }
  
  document.getElementById('resultModal').classList.remove('hidden');
  document.getElementById('resultModal').classList.add('flex');
}

async function saveTestResult(total, score) {
  const duration = Math.floor((Date.now() - startTime) / 1000); // ì´ˆ ë‹¨ìœ„
  
  const data = {
    test_name: `${testTextId} ìŠ¤í ë§ í…ŒìŠ¤íŠ¸ - ${testTextTitle}`,
    total_questions: total,
    correct_answers: correctCount,
    score: score,
    duration: duration,
    wrong_words: wrongAnswers
  };
  
  try {
    const response = await fetch('/save_test_result', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    
    if (response.ok) {
      console.log('í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì €ì¥ ì™„ë£Œ');
    } else {
      console.error('ê²°ê³¼ ì €ì¥ ì‹¤íŒ¨');
    }
  } catch (error) {
    console.error('ê²°ê³¼ ì €ì¥ ì¤‘ ì˜¤ë¥˜:', error);
  }
}

function closeResultModal() {
  document.getElementById('resultModal').classList.add('hidden');
  document.getElementById('resultModal').classList.remove('flex');
  document.getElementById('testArea').classList.add('hidden');
}

function restartTest() {
  closeResultModal();
  startSpellingTest();
}
</script>

{% endblock %}
