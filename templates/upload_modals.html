<!-- ✅ 텍스트 & 단어 업로드 모달 -->
<div id="uploadModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-2xl shadow-xl w-[800px] p-8">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-bold text-gray-800">텍스트 및 단어 업로드</h2>
      <button onclick="closeUploadModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
    </div>
    <p class="text-gray-500 mb-6">텍스트를 직접 입력하거나 단어를 추가해보세요.</p>

    <!-- ✅ 탭 메뉴 -->
    <div class="border-b mb-6">
      <nav class="flex space-x-8">
        <button id="tabText" onclick="switchTab('text')" class="pb-2 border-b-2 border-blue-600 text-blue-600 font-semibold">텍스트 업로드</button>
        <button id="tabWords" onclick="switchTab('words')" class="pb-2 text-gray-500 hover:text-blue-600">단어 업로드</button>
      </nav>
    </div>

    <!-- ✅ 텍스트 업로드 탭 -->
    <div id="textUploadTab">
      <label class="block text-sm font-semibold text-gray-700 mb-1">제목</label>
      <input id="uploadTitle" class="w-full border rounded-lg p-2 mb-4" placeholder="텍스트 제목을 입력하세요">

      <label class="block text-sm font-semibold text-gray-700 mb-1">출처 (선택사항)</label>
      <input id="uploadSource" class="w-full border rounded-lg p-2 mb-4" placeholder="예: BBC News, 교과서 등">

      <label class="block text-sm font-semibold text-gray-700 mb-1">텍스트 내용 *</label>
      <textarea id="uploadContent" rows="8" class="w-full border rounded-lg p-3" placeholder="영어 텍스트를 입력하거나 붙여넣기 하세요..."></textarea>

      <div class="flex justify-end mt-6 space-x-3">
        <button onclick="closeUploadModal()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">취소</button>
        <button onclick="submitTextUpload()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">저장</button>
      </div>
    </div>

    <!-- ✅ 단어 업로드 탭 -->
    <div id="wordUploadTab" class="hidden">
      <label class="block text-sm font-semibold text-gray-700 mb-1">텍스트 선택</label>
      <select id="textSelect" class="w-full border rounded-lg p-2 mb-4">
        <option value="">텍스트를 선택하세요</option>
      </select>

      <label class="block text-sm font-semibold text-gray-700 mb-1">단어 목록 (단어 뜻 형식으로 입력)</label>
      <textarea id="wordList" rows="8" class="w-full border rounded-lg p-3" placeholder="예시:\nplaza 광장\nproponent 지지자\nrelic 유물\nruin 유적\n..."></textarea>

      <div class="flex justify-end mt-6 space-x-3">
        <button onclick="closeUploadModal()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">취소</button>
        <button onclick="submitWordUpload()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">저장</button>
      </div>
    </div>
  </div>
</div>

<script>
// ✅ 탭 전환
function switchTab(tab) {
  const textTab = document.getElementById('textUploadTab');
  const wordTab = document.getElementById('wordUploadTab');
  const btnText = document.getElementById('tabText');
  const btnWord = document.getElementById('tabWords');

  if (tab === 'text') {
    textTab.classList.remove('hidden');
    wordTab.classList.add('hidden');
    btnText.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
    btnWord.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
  } else {
    textTab.classList.add('hidden');
    wordTab.classList.remove('hidden');
    btnWord.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
    btnText.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
    loadTextOptions();
  }
}

// ✅ 모달 열기 / 닫기
function openUploadModal() {
  const modal = document.getElementById('uploadModal');
  modal.classList.remove('hidden');
  modal.classList.add('flex');
}
function closeUploadModal() {
  const modal = document.getElementById('uploadModal');
  modal.classList.add('hidden');
}

// ✅ 텍스트 업로드
function submitTextUpload() {
  const title = document.getElementById('uploadTitle').value.trim();
  const source = document.getElementById('uploadSource').value.trim();
  const content = document.getElementById('uploadContent').value.trim();

  if (!title || !content) return alert('제목과 텍스트 내용을 입력해주세요.');

  fetch('/upload_text', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ title, source, content })
  })
  .then(res => res.json())
  .then(data => {
    if (data.error) alert('❌ 오류: ' + data.error);
    else {
      alert('✅ 텍스트 업로드 완료');
      closeUploadModal();
      location.reload();
    }
  })
  .catch(() => alert('❌ 업로드 중 오류가 발생했습니다.'));
}

// ✅ 단어 업로드
function submitWordUpload() {
  const textId = document.getElementById('textSelect').value;
  const rawList = document.getElementById('wordList').value.trim();

  if (!textId) return alert('텍스트를 선택해주세요.');
  if (!rawList) return alert('단어 목록을 입력해주세요.');

  // 단어 목록 파싱 (단어와 뜻은 공백 또는 탭으로 구분)
  const words = rawList.split('\n').map(line => {
    const [word, ...rest] = line.trim().split(/\s+/);
    return word && rest.length ? { word, meaning: rest.join(' ') } : null;
  }).filter(Boolean);

  fetch('/upload_words', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ text_id: textId, words })
  })
  .then(res => res.json())
  .then(data => {
    if (data.error) alert('❌ 오류: ' + data.error);
    else {
      alert('✅ 단어 업로드 완료');
      closeUploadModal();
      location.reload();
    }
  })
  .catch(() => alert('❌ 단어 업로드 중 오류 발생'));
}

// ✅ 텍스트 선택 목록 로드
function loadTextOptions() {
  const select = document.getElementById('textSelect');
  
  // 기존 옵션 초기화 (첫 번째 기본 옵션 제외)
  while (select.options.length > 1) {
    select.remove(1);
  }
  
  // API를 통해 텍스트 목록 가져오기
  fetch('/get_text_titles')
    .then(res => res.json())
    .then(texts => {
      texts.forEach(text => {
        const option = document.createElement('option');
        option.value = text.id;
        option.textContent = text.title;
        select.appendChild(option);
      });
    })
    .catch(err => {
      console.error('텍스트 목록 로드 실패:', err);
      alert('❌ 텍스트 목록을 불러올 수 없습니다.');
    });
}
</script>
